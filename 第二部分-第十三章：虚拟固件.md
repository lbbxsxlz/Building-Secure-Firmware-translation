## 第十三章

# 虚拟固件

在前几章中，我们讨论了系统中真实固件的安全设计。现在我们来看一下虚拟固件。图13-1是一个典型的I型虚拟化架构。当系统固件完成平台初始化后，会启动管理程序。然后，管理程序创建四个域并启动它们。每个客户机域都有自己的虚拟固件。虚拟固件为客户机操作系统准备所需的接口，并启动客户机操作系统。

在真实机器中，固件的目的是初始化硬件，并为操作系统（OS）提供通用接口。因此，操作系统可以与平台无关。在虚拟机中，虚拟固件也有同样的作用。虚拟固件为客户机操作系统提供相同的通用接口。例如，如果客户机操作系统是UEFI Windows或UEFI Linux，虚拟固件需要为客户机UEFI操作系统创建UEFI环境。

<div align=center><img src=Figures/Chapter-12-Screenshot/Figure-13-1.jpg></img></div>
<div align=center>图 13-1 虚拟化架构</div>

## 客户机域中的新威胁

当我们谈到安全，首先得要了解威胁模型。基于两种不同的使用案例，虚拟固件有两种不同的威胁模型：

    1） 客户机域信任管理程序

1972年，Anderson在“计算机安全技术规划研究”技术报告中提到了“参考监控器”的概念。参考监控器是一个抽象的机器，它控制着主体对客体的访问。参考监控器确保主体对客体拥有访问权限，并保护客体免受未经授权的访问。1974年，Popek和Goldberg发表了“可虚拟化的第三代体系结构的形式要求”，并提到了虚拟机监控器（VMM）（也称为管理程序）的三个特性：1）效率；2）资源控制；3）等价性。由于VMM可以控制系统资源，因此它是个很好的参考监控器备选。在大多数当前虚拟化架构中，VMM可以访问和控制客户机域的行为。例如，IT人员可能会在发送给企业用户的笔记本电脑上安装一个管理程序来保护客户机操作系统。当最终用户使用操作系统时，他们会信任管理程序。

在这种情况下，客户机依赖管理程序提供保护。虚拟固件可以信任硬件设备和管理程序提供的软件服务。管理程序控制着一切。虚拟固件无需考虑特殊的新威胁。

    2） 客户机域不信任管理程序

然而，云世界的情况发生了变化。在基础设施即服务（IaaS）模式中，云服务提供商（CSP）在物理机上建立了虚拟机监控器，并提供虚拟机作为服务来出租。现在的问题是：租客是否信任云服务提供商？让我们逐一考虑CIA的三要素：机密性、完整性和可用性。首先是机密性。租客可能不想与CSP共享公司的秘密数据。其次是完整性。租客可能不想让CSP修改任何公司数据。第三是可用性。租客可能不希望来自CSP的服务意外中断。

可用性应该由CSP维护。CSP在提供云服务时应采用可靠性、可用性和可维护性（RAS）。非信任输入在使用前应经过验证，例如网络数据包或磁盘镜像，这与真实系统固件类似。但是，如果CSP因网络断开或管理程序关闭而停止服务，虚拟固件将无能为力。

这种情况下的保密性和完整性比较特殊，因为CSP被视为恶意，并且CSP可能会尝试攻击客户机域。例如，攻击者可能会在管理程序中放置扫描仪来扫描客户机内存以获取机密。攻击者可能会在虚拟固件中植入rootkit来控制客户机操作系统。因此，客户机域需要一种方法来保护其数据免遭管理程序的攻击。

从高层来看，虚拟机数据可分为三类：1）处于静态的数据；2）传输中的数据；3）使用中数据。处于静态的数据可以通过加密来保护。传输中的数据可以通过网络协议（例如传输层安全TLS）来保护。使用中数据的保护需要虚拟固件的硬件辅助。

### 案例研究

现在，让我们来看一下虚拟化中安全扩展的一些实际案例。

#### AMD安全加密虚拟化（SEV）

当CPU执行代码或引用数据时，需要访问明文内存。在目前的大多数架构中，DRAM中的数据也是明文。这就带来了潜在的风险，如果攻击者能劫持内存总线，他们就能读取数据并修改数据。为了减少这种攻击，AMD采用了安全内存加密（SME），对发送到DRAM的数据进行加密（见图13-2）。因此，内存总线上或DRAM中的数据都是密文。每个CPU片上系统（SOC）都包含一个带有一个高级加密标准（AES）引擎AMD安全处理器（AMD-SP），用于加密和解密数据。AES密钥在每次重置系统时随机生成，并且SOC外部无法使用。

SME功能可以根据页表来部分启用。页表中的物理地址有一个enCrypted位（C位），用于指示该页是否需要加密。因此，操作系统可以决定哪些内存范围需要加密。为了向不知道新C位的操作系统提供支持，CPU可以代替使用透明SME(TSME)。在TSME模式下，无论C位是设置还是清除，所有内存都会被加密。

<div align=center><img src=Figures/Chapter-12-Screenshot/Figure-13-2.jpg></img></div>
<div align=center>图 13-2 AMD SME架构</div>
