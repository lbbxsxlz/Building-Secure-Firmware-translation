## 第二十章

# 编程语言

在本开发部分的最后一章中，我们将探讨固件开发中的语言选择。鉴于已有大量教材介绍各种编程语言本身，本文将不深入探讨语言细节，而是聚焦于固件开发中可能采用的不同语言的安全特性。

编程语言主要分为三类：机器语言、汇编语言和高级语言。如今几乎无人使用第一代机器语言——这种语言采用二进制格式0和1来表示机器代码。让我们从汇编语言开始探讨。

## 汇编语言

汇编语言是第二代编程语言。它属于低级语言，因为它使用符号替代二进制0和1来表示机器代码。汇编语言难以编写、调试、审查和维护。汇编语言中常见的问题罗列如下：
1) 非易失性寄存器访问：非易失性寄存器在函数调用过程中需被保护。例如，根据调用约定，RBX寄存器是非易失性寄存器。它应在函数入口处保存，并在函数退出时使用后恢复，或者完全避免在函数内使用。若RBX寄存器在函数内使用，但未被保护和恢复，将导致调用方与被调用方之间的契约失效。
2) 错误的栈偏移量：函数使用栈存储局部变量和函数参数。通常,这些数据可通过栈偏移量访问，例如[RBP – 0x20]或[RSP + 0x38]。其中RBP是栈基地址寄存器，RSP是栈指针寄存器。通常，RBP应该被使用，因为它一旦在函数入口处设定后就不会改变。使用RSP配合偏移量是危险的，因为RSP会受到栈PUSH和POP指令影响。数据可能通过[RSP + 0x38]正确访问，但在PUSH操作后，同一数据需通过[RSP + 0x40]访问。
3) 寄存器误用：指令集仅提供有限数量的寄存器。使用汇编语言时，程序员必须明确每个寄存器的用途。有时指令要求使用RDX寄存器，但代码却使用了另一个寄存器RAX。这是典型的复制粘贴错误。程序员从其他地方复制代码片段后，忘记更新所有相关位置。
4) 循环计数器偏移量错误：指令集包含循环计数器寄存器，例如IA指令集中的RCX。LOOP指令会导致RCX自减。类似于C语言的for循环，错误的计数器可能引发偏移量错误（OBOE），进而导致缓冲区溢出。
5) 语法混淆：汇编语言缺乏标准。不同汇编语法可能产生不同的机器码转换方式。以IA指令为例。GNU汇编器(GSA)采用AT&T语法，微软汇编器(MASM)则使用Intel语法。最大问题在于这两种语法中源操作数与目标操作数的顺序存在差异。若需将RCX寄存器值存入RAX寄存器，Intel语法应写为“MOV RAX, RCX”，AT&T语法则为“MOVQ %RCX, %RAX”。我们见过大量案例：开发者因只熟悉其中一种语法，在复制代码后转换为另一种语法时，因顺序错误导致问题。

