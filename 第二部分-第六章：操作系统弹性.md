## 第六章

# 操作系统弹性

在个人电脑或服务器中，当主机固件完成初始启动时，它会将控制权转交给主机操作系统（OS）加载程序。然后，主机操作系统加载程序将控制权转移到最终操作系统（OS）。操作系统可能由制造商、企业信息技术（IT）部门或最终用户安装。典型的操作系统是Windows或Linux。对于移动设备，可能还有其他类型的通用操作系统，如Chromium、Android或iOS。它们由平台制造商创建或定制，作为整个移动设备解决方案的一部分。在嵌入式系统或微控制器中，操作系统与固件紧密结合，甚至是固件的一部分。其中一些解决方案包括实时操作系统（RTOS），例如FreeRTOS、RT-Thread、Contiki OS、mbed OS、ThreadX、uC/OS、LiteOS、TinyOS等。

由于操作系统是提供真正服务的环境，操作系统是攻击的主要目标。如果个人电脑中的Windows或Linux操作系统实例受到攻击，最终用户可能需要重新安装新的操作系统。但是，如果手机中的Android或iOS实例受到攻击，用户又如何安装新的呢？更不用说运行在嵌入式系统中的RTOS了，最终用户根本不知道它的存在。从整个解决方案的角度来看，"弹性"的概念应从固件扩展到操作系统。

与固件弹性类似，操作系统的弹性也包括三个部分：保护、检测和恢复。由于本书聚焦于固件，我们将不介绍操作系统弹性的所有方面，而重点关注与固件相关的部分。

## 保护

### 自动更新

目前大多数商业操作系统，例如Windows、Linux、Android和iOS，都支持自动组件更新。更新服务由操作系统供应商提供，并且在后台运行。每当操作系统供应商发布新版本时，最终用户就会收到通知，补丁就会自动部署。

自动更新的好处是操作系统软件版本始终是最新的。一旦补丁可用，操作系统软件的漏洞就能立即得到修复。

## 检测

### 镜像签名

镜像签名验证是一种有效的检测机制。UEFI安全启动就是在UEFI固件中使用这一机制的解决方案之一。镜像签名验证从固件扩展到操作系统内核。一些操作系统，如Windows10会强制执行代码签名策略来确保执行代码的完整性。

### 案例研究

现在，让我们来看下操作系统/加载程序安全启动的一些实例。

#### Linux机器所有者密钥（MOK）

UEFI安全启动定义了密钥层次结构。平台密钥（PK）由平台所有者提供。这里的平台所有者通常指创建机器的平台制造商，但也可能是其他人，如最终用户。PK用于签署密钥交换密钥（KEK），该密钥由操作系统供应商提供。KEK用于签署允许的镜像数据库和禁止的镜像数据库。当前的平台通常默认启用UEFI安全启动。由于最终用户没有PK或KEK，他们无法在数据库中注册任何新镜像。对于只想使用操作系统的最终用户来说，这种设计是不错的。但在Linux世界中，开发者被视为机器的所有者。如果开发者更新了操作系统加载程序或操作系统内核，并在自己的启用了UEFI安全启动的机器上测试更新，该怎么办？

开发者可以禁用UEFI安全启动。根据Windows logo使用UEFI的要求，UEFI安全启动可在用户实际场景下禁用。UEFI规范本身未提及禁用该功能。不过，一旦UEFI安全启动被禁用，恶意软件可能会在UEFI安全启动再次启用前安装到系统上，这是一个潜在的风险。

Linux的最低安全启动要求如下： 1）操作系统加载程序必须使用固件中注册的密钥签名，并由固件验证。2）操作系统内核必须使用操作系统加载程序信任的密钥签名，并由操作系统加载程序验证。一种方法是为所有固件注册一个Linux密钥，类似于UEFI证书颁发机构（CA）和微软使用的方法，让所有其他固件注册UEFI CA/Windows密钥。但这会带来扩展性问题。

另一种方法是让UEFI证书颁发机构签署一个Linux程序作为楔子（shim）。然后，就可以使用这个楔子（shim）在Linux世界中使用已知的机器所有者密钥 (MOK)去构建一个新的密钥层次结构。表6-1列出了MOK和UEFI安全启动密钥之间的区别。

表 6-1 MOK和UEFI安全启动密钥
| **密钥** | **谁提供** | **谁注册** | **签名** | **存储** |
| :--- | :--- | :--- | :--- | :--- |
| UEFI安全启动密钥（PK）| 平台所有者 —— 平台制造商 | 平台拥有者 —— 平台制造商 | KEK | UEFI已认证变量 |
| UEFI安全启动密钥（KEK）| 操作系统供应商 —— UEFI证书颁发机构（CA），微软 | 平台拥有者 —— 平台制造商 | db/dbx | UEFI已认证变量 |
| UEFI安全启动密钥（db/dbx）| 操作系统供应商 —— UEFI证书颁发机构（CA），微软 | 平台拥有者 —— 平台制造商 | UEFI option ROM，UEFI加载程序（Windows操作系统加载程序），Linux shim | UEFI已认证变量 |
| Linux MOK | 机器所有者 —— 最终用户 | 机器所有者 —— 最终用户 | Linux操作系统加载程序， Linux操作系统内核 | UEFI启动服务变量（未认证）|

