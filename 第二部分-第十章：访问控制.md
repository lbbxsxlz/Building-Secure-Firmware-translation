## 第十章

# 访问控制

访问控制是一种重要的安全机制，用于控制主体如何访问对象。这里的主体通常指终端用户，但也可以是计算机或运行中的进程。对象是指计算机系统或服务。对象可以是硬件，如网络或存储设备。对象也可以是软件，如操作系统或数据库。最后，对象可以是数据，如文件、注册表项或内存内容。典型的访问是指读取、写入或执行。访问分类还包括其他操作，如修改、创建、删除、追加、扩展等。访问控制可以保护系统和资源免遭未经授权的使用。在固件领域也是如此。

图10-1显示了BIOS中潜在的主体和对象集。例如，用户需要输入用户密码才能继续启动，或输入管理员密码才能进入设置用户界面（UI）页面。用户需要输入WIFI密码才能在BIOS中启用无线网络。平台BIOS会将固件组件测量值延伸到平台配置寄存器（PCR），以便Microsoft BitLocker从可信平台模块（TPM）设备中解封磁盘加密密钥。只有在正确的PCR值延伸到TPM后，平台才能访问存储设备。只有创建TEE的早期固件才能访问可信执行环境（TEE）。这种早期启动的开放访问有时被称为时间隔离。一旦构建了TEE，非TEE代码就不能再访问TEE环境。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-10-1.jpg></img></div>
<div align=center>图 10-1 固件中的主题与对象</div>

对于对象来说，三大安全原则是CIA —— 机密性、完整性和可用性。对于此次主题，我们需要考虑的是IAA —— 识别、认证和授权。识别是主体声称拥有特定身份的手段。例如，用户拥有用户名、电子邮件地址或手机号码作为身份。认证是系统用来验证主体身份的过程。三种典型的身份验证手段包括：(1) 使用主体知道的东西，例如密码；(2) 使用主体拥有的东西，如智能卡；(3) 使用主体本身，例如指纹。身份识别和认证信息构成了主体的凭证。凭证会与该主体的预存凭证进行比较。如果两者匹配，则主体通过认证。

当主体通过认证后，系统需要确定主体可以访问哪些对象资源。这可以是预定义的访问矩阵，也可以是对象的安全标签。如果系统确定主体可以访问对象，就会对主体进行授权。

固件中的识别、认证和授权可以简化。例如，如果系统只支持一个用户，则可以跳过用户识别，只需进行认证。授权也可以很简单，只需继续启动即可。

在接下来的章节中，我们将从对象的角度逐一讨论访问控制功能。

## 启动访问控制

BIOS的主要作用和职责之一是启动系统。BIOS可以添加一些启动访问控制，只允许某些人启动系统。

### 用户知道什么：密码

BIOS密码在个人电脑发展史上很早就出现了。通常情况下，BIOS通常支持用户密码和管理员（admin）密码。系统启动时，会弹出对话框，让终端用户输入用户密码。如果用户密码正确，系统将继续启动；如果不正确，系统将拒绝启动请求并重置或关闭系统。当终端用户希望进入BIOS设置用户界面（UI）时，BIOS可能会弹出对话框，要求终端用户输入管理员密码。如果管理员密码正确，BIOS将显示设置页面让用户修改BIOS配置。如果管理员密码不正确，BIOS不会进入设置页面。此功能称为BIOS密码或BIOS用户认证。

### 密码存储

密码信息必须存储在非易失性存储器中。传统BIOS通常使用CMOS RAM作为非易失性存储器（NVS）。标准CMOS RAM只有128字节，扩展CMOS RAM还有128字节。CMOS RAM可通过I/O端口70/71和I/O端口72/73读写。CMOS RAM的存储由CMOS电池维持。如果终端用户取出CMOS电池，CMOS内容将被清除。

CMOS区域不防篡改。如果密码存储在CMOS中，很容易受到攻击。攻击者可以通过向端口70/71写入直接更新CMOS RAM或通过移除CMOS电池清除CMOS内容。

如今，由于上述安全问题，UEFI BIOS不再使用CMOS RAM作为非易失性存储。必须使用防篡改存储设备来存储加密的密码。大多数UEFI BIOS实现都使用闪存设备作为非易失性存储设备，用于在UEFI变量中存储密码。必须确保用于密码的闪存设备部分的完整性保护。

### 密码加密

密码不应直接以纯文本形式存储在非易失性存储器中。相反，必须对密码进行加密以保持其机密性，这样就无法从存储在非易失性存储器中的值猜出密码。通常，密码使用单向函数 —— 哈希进行加密。哈希值（而非密码）存储在非易失性存储器中。密码验证过程使用相同的单向函数计算输入密码的哈希值，并比较计算值和存储值之间的结果。

然而，仅仅存储密码的哈希值很容易受到彩虹表攻击。彩虹表是一个预先计算出常用密码哈希值的数据库。有了彩虹表，攻击者只需将彩虹表中的值与存储值进行比较，这比散列计算要快得多。

为了减少彩虹表攻击，在进行哈希计算之前，应在密码中附加盐值。密码验证过程如下：从存储区获取盐值，计算输入密码和盐的哈希值，然后将计算值与存储值进行比较。在使用盐值时，固定彩虹表是无用的。盐值不应该是一个固定值。它必须尽可能随机。例如，每个平台都应在运行时生成盐值确保不同平台的盐值不同。当用户更改密码时，可以生成新的盐值。

添加盐值的目的是确保哈希值反向计算时间更接近暴力破解的时间，而不是使用彩虹表查找时所需的更短时间。

另一种增加哈希逆向计算时间的方法是增加哈希迭代次数。哈希迭代次数是将哈希函数的输出作为输入，然后反复计算结果的次数。如果迭代次数较多，例如1000次，攻击者就需要花费更多时间来计算字典中每个密码的最终结果。但与用户输入密码的时间相比，一次密码计算的影响可以忽略不计。

在选择计算哈希的单向函数时，应使用慢速散列函数，例如基于密码的密钥推导函数2（PBKDF2）。较慢的时间意味着攻击者必须花费更多时间创建彩虹表来实施攻击。

推荐的加密算法如图10-2所示。BIOS应采用BIOS密码解决方案的所有良好做法。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-10-2.jpg></img></div>
<div align=center>图 10-2 密码加密</div>

### 强化密码执行

即使在今天，人们仍然倾向于使用简单的密码，如123456。在输入或配置密码时，BIOS应执行强密码要求。例如，密码长度必须大于或等于8，密码中必须至少有一个小写/大写字母、数字和符号。BIOS应执行强密码要求，并在配置过程中拒绝弱密码。

### 密码更新执行

有些计算机系统有强制更改密码的要求。用户被要求在一段时间后更改系统密码，例如三个月。这一要求也可以在BIOS中实现。例如，BIOS可以在存储密码的同时保存创建密码的日期，并将当前日期与存储值进行比较。然而，对于终端用户来说，不断更改BIOS密码可能是一种负担。此外，个人电脑通常不支持可信时间源、
因此，攻击者可能会绕过这一要求。

### 密码历史

密码历史是以前密码的哈希值，例如三个最新密码或五个最新密码。如果用户被要求更换新密码，有些系统会通过比较与之前的密码比较哈希值来检查新密码是否曾被使用过。这是防止用户再次使用旧密码的一种方法。BIOS也可以通过保存旧密码哈希值和盐值来实现这一功能，以便与新密码哈希值进行比较。

### 密码重试限制

在普通操作系统或网页登录页面中，用户只能尝试输入有限次数的密码，如三次或五次。在重复失败达到预定次数后，账户会被锁定一段时间，以防止再次尝试。

BIOS密码设计应使用类似的机制。如果达到最大尝试次数，BIOS就应停止接受任何进一步的密码输入。用户需要重置系统后才能再次尝试。

### 密码丢失

有时，用户真的会忘记自己的密码。大多数网页都支持重置密码选项。用户点击忘记密码链接后，系统会向终端用户注册的电子邮件或手机发送一个新的链接。然而，要在BIOS中实现这样的解决方案并不容易，因为这需要在BIOS中建立完整的网络栈、完整的用户注册流程以及专门用于BIOS用户管理的数据库。这对BIOS实现和系统制造商来说都是巨大的负担。

平台设计者必须在系统的可用性和安全性之间取得平衡。高保障平台可能会要求将平台送回制造商处解锁，例如退货授权（RMA）流程。另一种替代解决方案是让用户通过另一台机器以正确的用户身份提交密码重置请求，并允许远程管理员通过带外（OOB）方法清除密码。低端平台可允许终端用户按下特殊的组合键或进入恢复模式来清除新密码，在用户实际在场并假设触摸机器者是机器的所有者的情况下。

### 密钥验证

密码验证或更新必须在可信的执行环境中进行，例如系统管理模式（SMM）或早期的在任何第三方代码运行前的UEFI环境。如果密码需要更新，旧密码验证和新密码更新必须在同一个可信的执行环境中进行，两者之间不得有任何中断。

### 密码管理

典型的BIOS密码存储在本地的NV存储区中。然而，在企业环境中，系统密码可能由专用密钥服务器管理。例如，Kerberos是使用在操作系统中的一种网络验证协议，例如Windows或Linux。使用Kerberos时，客户端向远程Kerberos服务器发送用户身份和凭证。用户信息和密码存储在Kerberos服务器中，身份认证在Kerberos服务器中进行。

BIOS可以实现Kerberos客户端。一旦用户输入密码凭证，BIOS的Kerberos客户端就会与远程Kerberos服务器通信，完成用户身份认证。必须注意远程Kerberos服务器的位置。如果服务器位置保存在UEFI NV存储区域，则必须保护该数据。否则，攻击者可能会尝试修改Kerberos服务器的位置，并将操作重定向到假的服务器。

### BIOS更新模式

如果加密的用户密码保存在NV存储区域，在BIOS更新期间这密码信息应该保留。

### S3恢复模式

