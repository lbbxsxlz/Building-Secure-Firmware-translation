# 维护

产品发货后，我们将进入产品维护阶段。此后可能收到来自外部或内部客户的安全问题报告。一旦确认问题，我们需要修复该问题并准备固件更新，以便部署到所有现有的在用产品中。修复安全问题的时间至关重要，因为从问题发现到修复完成期间，产品始终面临遭受攻击的风险。

## 缓解策略与对策

微软描述了软件漏洞缓解策略 —— 使漏洞的发现、利用和滥用变得困难且代价高昂 —— 并提出了四项对策（消除漏洞、破坏利用途径、控制损害范围、缩短漏洞利用时间窗口）。这些策略和对策同样适用于固件漏洞缓解。表23-1展示了固件漏洞缓解对策。

表 23-1 固件漏洞缓解对策

|  对策  | 架构与设计 |  实现  |  维护  |
| ------ | ------ | ------ | ------ |
| 消除漏洞 | 减少攻击面，例如不必要的SMI处理程序。<br>采用安全设计原则，例如最小权限原则。<br>使用正确的加密算法。| 启用编译器防御性技术，例如代码消毒器、静态分析和动态分析。<br>使用类型安全的语言，例如Rust。<br>使用漏洞扫描工具。| 增强漏洞扫描工具。|
| 破坏利用 | 采用固件弹性机制 —— 保护、检测和恢复功能 —— 例如安全启动。<br>采用固件完整性测量与证明机制，例如测量启动。| 启用编译器防御技术，例如栈、cookie、地址空间布局随机化（ASLR）、数据执行保护（DEP）、代码完整性防护（CIG）、任意代码防护（ACG）、控制流防护（CFG）等。<br>启用内核保护技术，如监督模式执行预防（SMEP）、监督模式访问预防（SMAP）、内核页表隔离（KPTI）等。| |
| 控制损害 | 采用容器与虚拟化技术（纵向）。<br>采用隔离与分区技术（横向）。| 启用监督模式。<br>启用虚拟机监控程序。<br>启用可信执行环境（TEE）。| |
| 减少攻击窗口 | 采用固件弹性机制 —— 更新。<br>定义固件更新流程。| 启用固件组件级更新。| 启用固件供应链检测。<br>启用有效的固件漏洞检测。<br>UEFI扫描器。|

表 23-2 UEFI/EDK II系统固件中的示例

|  对策  | 方法 | UEFI/EDK II示例 |
| ------ | ------ | ------ |
| 消除漏洞 | 减少攻击面<br>静态分析/动态分析<br>安全测试/模糊测试<br>/漏洞扫面 | SMI处理程序配置文件<br>Clang静态分析，内存消毒器，KLEE<br>基于主机的固件分析器，Peach，AFL<br>CHIPSEC |
| 破坏利用 | 栈防护<br>地址空间布局随机化<br>数据执行预防<br>任意代码防护<br>控制流防护<br>代码完整性防护 | MSVC:/GS, GCC:-fstack-protector<br>DXE/SMM ASLR<br>SMM内存保护<br>UEFI核心内存保护<br>DXE/SMM控制流强制技术（CET）<br>UEFI安全启动 |
| 控制损害 | 沙箱<br>降权<br>隔离 | EBC<br>基于Ring3的OPROM，SMI处理程序<br>基于Ring3的OPROM，SMI处理程序 |
| 减少攻击窗口 | 弹性<br>测量与证明<br>防病毒 | 签名更新，安全启动，签名恢复，闪存锁定<br>测量启动（SRTM），安全启动（DRTM）<br>UEFI扫描器 |

## 固件组件的供应链

通常而言，供应链管理是管理产品与服务生命周期的方法。固件是平台级供应链中最关键的组件之一。我们需要一种可靠的方法来追踪特定平台的每个固件镜像，确保其处于最新状态且未被篡改。

### 固件组件证书与清单

固件组件证书包含组件制造商作出的信任声明，其声明组件出厂时的安全属性与配置。例如，TCG平台证书描述了出厂平台的属性。TCG背书密钥证书用于将身份绑定至平台上的可信平台模块（TPM），而TCG证明身份密钥（AIK）证书则基于TPM的证明能力提供平台认证。TCG设备标识符组合引擎（DICE）包含多个证书来支持层级证书，包括设备制造商签发的初始设备标识符（IDevID）证书、设备所有者签发的本地设备标识符（LDevID）证书、CA签发的嵌入式证书颁发机构（ECA）证书，以及ECA或CA签发的证明证书。表23-3列出了固件组件证书涉及的标准。

表 23-3 固件组件证书

| 平台证书 | 证书格式 | 数据格式 |
| ------ | ------ | ------ |
| TCG平台证书概要 —— TCG基础设施工作组 | X.509, 目录：公钥与属性证书框架 —— ITU X.509 | 增强的隐私邮件（PEM）—— RFC 1421，7468 BASE64编码 —— RFC 4648 |
| TCG背书密钥（EK）凭证概要 ——  TCG基础设施工作组 | 授权的互联网属性证书概要 —— RFC 5755 | 抽象语法标记（ASN.1）区分编码规则（DER）—— ITU X690 |
| TCG DICE证书概要 —— TCG设备标识符组合引擎工作组 | | |

组件证书应包含引用清单信息。因此，验证者可以获取组件信息进行证明。例如，TCG平台证书包含一个PlatformConfigurationURI属性。验证者可通过此统一资源标识符（URI）获取参考完整性清单或测量（RIM）。此参考完整性清单格式需符合ISO/IEC 19770-2规范定义的软件标识符（SWID）标签，或IETF安全自动化与持续监控（SACM）工作组定义的简明标识符（CoSWID）标签。SWID标签采用可扩展标记语言（XML）格式，而CoSWID则采用简洁二进制对象表示法（CBOR）格式。CBOR作为数据格式，其设计目标包括实现极小的代码尺寸、相对较小的消息大小，以及无需版本协商即可扩展的特性。其底层数据模型为JSON。CBOR编码远小于ASN.1编码，因此更适用于嵌入式或物联网（IoT）环境。除了CoSWID定义外，IETF远程证明程序（RATS）工作组还为CoSWID添加了RIM扩展，以满足TCG RIM规范的需求。

固件更新包也可包含清单文件。它可采用TCG参考完整性清单（RIM）格式，或基于CBOR的IETF物联网软件更新（SUIT）清单格式。SUIT清单不仅包含固件更新镜像及其相关信息，还包含要求接收方执行的指令。表23-4列出了固件组件清单涉及的相关标准。

表 23-4 固件组件清单

| 固件组件清单 | 固件识别标签 | 数据格式 |
| ------ | ------ | ------ |
| TCG参考完整性清单（RIM）—— TCG基础设施工作组<br>互操作性SWID标签创建指南 —— NIST IR 8060 | 软件标识符（SWID）标签 —— ISO/IEC 19770-2:2015 | 可扩展标记语言（XML）—— W3C<br>XML签名语法与处理 —— W3C<br>XML模式定义（XSD）—— W3C |
| CoSWID的RIM扩展 —— IETF远程证明程序（RAP）工作组<br>基于CBOR格式的SUIT清单 —— IEFT物联网软件更新工作组 | 简明软件标识标签（CoSWID）—— IETF安全自动化与持续监控（SACM）工作组 | 简洁二进制对象表示法（CBOR）——RFC 7049<br>CBOR对象签名与加密（COSE）——RFC 8152<br>简洁数据定义语言（CDDL）——RFC 8610 |

### 固件证明数据

运行时，平台信任根与信任链会记录平台中固件组件的证明，并将其报告给验证者。验证者可将组件数据与参考清单比对，以判定系统是否可信。以TCG平台固件配置文件为例，平台静态测量信任根将系统固件哈希值扩展至可信平台模块（TPM）的平台配置寄存器（PCR），并将哈希值记录至TCG事件日志。运行时，验证者通过TPM引用流程验证TPM证明密钥签名的PCR值。随后处理TCG事件日志中的哈希数据，尝试复现PCR值中的哈希值。此时验证者可比对TCG事件日志中的固件哈希值与平台参考完整性清单中的固件哈希值。

除系统固件测量外，设备固件测量数据可通过主机与设备间的DMTF安全协议与数据模型（SPDM）协议获取。测量数据由设备使用其私有证书签名。验证者可使用设备公钥证书验证测量结果，并将其与参考完整性清单中的设备固件哈希值进行比对。
