## 第二十一章

# 安全单元测试

在完成所有代码开发工作后，我们需要进行安全测试。通常开发人员需先执行安全单元测试，再将代码交付给测试团队。此时，测试团队需开展更全面的系统级安全测试。市面上有大量介绍软件测试技术的书籍，本章将不再赘述相关内容。相反，在本章，我们将从开发人员视角聚焦固件特有的安全单元测试。在下一章，我们将从测试工程师视角探讨固件特有的系统安全测试。

## 安全单元测试计划

在第二章中，我们探讨了主动式固件安全开发的整体理念，并阐述了威胁模型。安全单元测试应聚焦于威胁模型，以验证已识别的威胁是否得到妥善缓解。我们还指出了固件中的八个高风险区域，并提供了安全代码审查的指导原则。表21-1展示了针对这些区域的安全单元测试。

表 20-1 针对8个高分线区域的安全单元测试

|  类别  |  安全单元测试  |
| :----- | :----- |
| 外部输入 | 识别外部输入 —— SMM通信缓冲区、UEFI变量、固件镜像和胶囊镜像、启动BMP文件、PE/COFF镜像（例如一个操作系统引导加载程序和PCI选项ROM）、文件系统、磁盘镜像、网络数据包等。<br>识别处理外部输入的功能 —— 边界函数。识别执行外部输入检查的功能 —— 检查函数。<br>使用不同输入测试检查函数。<br>验证检查函数的输出结果。|
| 竞争条件 | 识别关键资源 —— SMM通信缓冲区、锁定的硅寄存器等。<br>识别处理关键资源的功能。创建访问关键资源的竞争条件场景。<br>验证关键资源的结果。|
| 硬件输入 | 识别硬件输入 —— 读写硅寄存器、内存映射输入/输出（MMIO）基址寄存器（BAR）、USB描述符、蓝牙低功耗（BLE）广播数据、DMA、缓存等。<br>识别处理硬件输入的函数。<br>识别执行硬件输入检查的函数 —— 检查函数 —— 或识别预防攻击的函数 —— 锁定函数。<br>模拟硬件输入，例如MMIO BAR、USB、BLE等，并测试检查函数。<br>验证检查函数的输出结果。<br>验证锁定函数能否正确执行锁定操作，例如DMA或SMM缓存等。|
| 秘密处理 | 识别秘密/密码。<br>识别使用密钥的函数。<br>识别使用后清除密钥的函数。<br>确保所有路径中的秘密均被清除。<br>若需保存秘密，识别对其进行哈希或加密的函数。<br>识别默认秘密/密码处理机制。<br>验证是否遵循侧信道指南。|
| 寄存器锁定 | 识别需要锁定的寄存器，例如闪存锁定和SMM锁定。<br>识别锁定寄存器的函数。<br>识别控制锁定的策略，例如策略协议或变量。<br>确保最终用户无法控制策略。<br>确保锁定操作在所有启动路径中均会发生。<br>确保锁定操作在任何第三方代码运行之前完成。|
| 安全配置 | 识别控制安全配置的策略，例如安全启动和可测量启动。<br>确保未经授权的最终用户无法更新安全配置。<br>确保默认配置是安全的。|
| 重放/回滚 | 识别安全版本号（SVN）或最低支持版本号（LSN）。<br>识别SVN或LSN的存储位置。<br>确保未经授权的最终用户无法更新SVN或LSN。识别执行版本检查的函数。|
| 密码学 | 识别固件中的加密的用途，例如签名验证或数据加密。<br>识别固件中使用的加密的算法。<br>确保加密算法遵循政府和企业的最新指南，不得使用任何已弃用的算法。<br>确保密钥长度符合政府和企业的最新指南，不得使用过短的密钥长度。<br>识别密钥生成函数和密钥撤销函数。<br>识别密钥存储。<br>
识别用于保障密钥存储完整性与或保密性的保护机制。<br>仅授权用户可更新密钥。<br>验证是否遵循侧信道防护指南来保障密钥保密性。<br>确保签名验证函数能处理密钥缺失或签名缺失的情况。|