## 第二十一章

# 安全单元测试

在完成所有代码开发工作后，我们需要进行安全测试。通常开发人员需先执行安全单元测试，再将代码交付给测试团队。此时，测试团队需开展更全面的系统级安全测试。市面上有大量介绍软件测试技术的书籍，本章将不再赘述相关内容。相反，在本章，我们将从开发人员视角聚焦固件特有的安全单元测试。在下一章，我们将从测试工程师视角探讨固件特有的系统安全测试。

## 安全单元测试计划

在第二章中，我们探讨了主动式固件安全开发的整体理念，并阐述了威胁模型。安全单元测试应聚焦于威胁模型，以验证已识别的威胁是否得到妥善缓解。我们还指出了固件中的八个高风险区域，并提供了安全代码审查的指导原则。表21-1展示了针对这些区域的安全单元测试。

表 20-1 针对8个高分线区域的安全单元测试

|  类别  |  安全单元测试  |
| :----- | :----- |
| 外部输入 | 识别外部输入 —— SMM通信缓冲区、UEFI变量、固件镜像和胶囊镜像、启动BMP文件、PE/COFF镜像（例如一个操作系统引导加载程序和PCI选项ROM）、文件系统、磁盘镜像、网络数据包等。<br>识别处理外部输入的功能 —— 边界函数。识别执行外部输入检查的功能 —— 检查函数。<br>使用不同输入测试检查函数。<br>验证检查函数的输出结果。|
| 竞争条件 | 识别关键资源 —— SMM通信缓冲区、锁定的硅寄存器等。<br>识别处理关键资源的功能。创建访问关键资源的竞争条件场景。<br>验证关键资源的结果。|
| 硬件输入 | 识别硬件输入 —— 读写硅寄存器、内存映射输入/输出（MMIO）基址寄存器（BAR）、USB描述符、蓝牙低功耗（BLE）广播数据、DMA、缓存等。<br>识别处理硬件输入的函数。<br>识别执行硬件输入检查的函数 —— 检查函数 —— 或识别预防攻击的函数 —— 锁定函数。<br>模拟硬件输入，例如MMIO BAR、USB、BLE等，并测试检查函数。<br>验证检查函数的输出结果。<br>验证锁定函数能否正确执行锁定操作，例如DMA或SMM缓存等。|