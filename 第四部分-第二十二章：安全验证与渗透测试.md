# 安全验证与渗透测试

在完成开发、安全代码审查和安全单元测试后，固件代码将被提交。此时，验证团队可开展安全验证与渗透测试活动。真正的安全验证工作其实更早便已启动，即在威胁建模阶段。那时，安全验证团队需参与威胁模型讨论，并同步制定安全验证计划与渗透测试计划。

## 安全验证计划

在第二章中，我们探讨了主动式安全固件开发，特别是威胁模型。安全验证计划应聚焦于威胁模型。验证团队或渗透测试团队应将自身视为定义中的攻击者，进而对系统发起攻击。

前几章介绍了各类攻击手段与缓解措施，以及安全设计与实现方法。固件中存在八个高风险区域，这些区域将成为攻击者的首要目标。综合上述信息，我们在表22-1中列出了安全验证或渗透测试的若干建议。

表 22-1 安全验证与渗透测试建议

|  分类  |  安全验证  |
| -------- | -------- |
| 外部输入 | 模糊外部输入<br>1) 文件模糊测试可应用于不同类型的文件解析器，包括启动LOGO文件，例如位图格式BMP和联合图像专家组格式JPEG；固件更新胶囊文件或恢复文件，例如UEFI胶囊文件；第三方固件可执行文件，例如可移植可执行格式PE和可执行链接格式ELF；配置文件，例如可扩展标记语言XML和JavaScript对象表示法JSON等。<br>2) 文件系统模糊测试可应用于文件系统及磁盘分区，包括文件分配表（FAT）、新技术文件系统（NTFS）、扩展文件系统（EXT2/3/4）、 分层文件系统（HFS）、通用光盘格式（UDF）、紧凑光盘文件系统（CDFS）、El Torito、闪存文件系统（FFS）或固件文件系统（FFS）。<br>3) 协议模糊测试可应用于固件网络协议栈，包括以太网、WiFi、蓝牙、蜂窝网络（3G、4G、5G）、地址解析协议（ARP）、互联网协议（IP）第4版与第6版、互联网协议安全（IPsec）、传输控制协议（TCP）、用户数据报协议（UDP）、 传输层安全协议（TLS）、动态主机配置协议（DHCP）、预启动执行环境（PXE）、域名服务器（DNS）、超文本传输协议（HTTP）、表征状态转移（REST）、智能平台管理接口（IPMI）、RedFish、通用即插即用（UPNP）等，以及设备通信协议，包括安全协议与数据模型 (SPDM)。<br>4) 管理模式或可信世界模糊测试可用于管理模式或可信世界通信缓冲区及管理模式中断（MMI）处理程序，例如X86系统管理模式（SMM）或ARM TrustZone，特别是用于通信的软件管理模式中断。<br>5) 可采用数据特定模糊测试，例如UEFI/PI BIOS的UEFI变量数据、S3唤醒的PI启动脚本数据、平台信任根模块的启动策略清单(BPM)、动态信任根模块(DRTM)的ACPI表等。<br>侧信道攻击<br>1) 若管理模式或可信环境包含机密信息，检查管理模式处理程序是否采用侧信道防护最佳实践，例如Spectre防护机制。<br>2) 若内核模式包含机密信息，检查内核处理程序是否采用侧信道防护最佳实践，例如Spectre和Meltdown防护机制。
| 竞争条件 | 检查时间/使用时间攻击<br>1) 针对管理模式或可信世界通信缓冲区的TOC/TOU攻击。<br>2) 针对固件更新工具使用的数据缓冲区的TOC/TOU攻击。3) 针对经平台信任根验证后的闪存固件镜像的TOC/TOU攻击。<br>多处理器的竞争条件。<br>1) 使一个处理器进入管理模式或可信环境以解锁寄存器，并让另一个处理器利用解锁后的系统状态，例如闪存解锁。|
