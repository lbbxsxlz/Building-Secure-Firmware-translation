# 安全验证与渗透测试

在完成开发、安全代码审查和安全单元测试后，固件代码将被提交。此时，验证团队可开展安全验证与渗透测试活动。真正的安全验证工作其实更早便已启动，即在威胁建模阶段。那时，安全验证团队需参与威胁模型讨论，并同步制定安全验证计划与渗透测试计划。

## 安全验证计划

在第二章中，我们探讨了主动式安全固件开发，特别是威胁模型。安全验证计划应聚焦于威胁模型。验证团队或渗透测试团队应将自身视为定义中的攻击者，进而对系统发起攻击。

前几章介绍了各类攻击手段与缓解措施，以及安全设计与实现方法。固件中存在八个高风险区域，这些区域将成为攻击者的首要目标。综合上述信息，我们在表22-1中列出了安全验证或渗透测试的若干建议。

表 22-1 安全验证与渗透测试建议

|  分类  |  安全验证  |
| -------- | -------- |
| 外部输入 | 模糊测试外部输入<br>1) 文件模糊测试可应用于不同类型的文件解析器，包括启动LOGO文件，例如位图格式BMP和联合图像专家组格式JPEG；固件更新胶囊文件或恢复文件，例如UEFI胶囊文件；第三方固件可执行文件，例如可移植可执行格式PE和可执行链接格式ELF；配置文件，例如可扩展标记语言XML和JavaScript对象表示法JSON等。<br>2) 文件系统模糊测试可应用于文件系统及磁盘分区，包括文件分配表（FAT）、新技术文件系统（NTFS）、扩展文件系统（EXT2/3/4）、 分层文件系统（HFS）、通用光盘格式（UDF）、紧凑光盘文件系统（CDFS）、El Torito、闪存文件系统（FFS）或固件文件系统（FFS）。<br>3) 协议模糊测试可应用于固件网络协议栈，包括以太网、WiFi、蓝牙、蜂窝网络（3G、4G、5G）、地址解析协议（ARP）、互联网协议（IP）第4版与第6版、互联网协议安全（IPsec）、传输控制协议（TCP）、用户数据报协议（UDP）、 传输层安全协议（TLS）、动态主机配置协议（DHCP）、预启动执行环境（PXE）、域名服务器（DNS）、超文本传输协议（HTTP）、表征状态转移（REST）、智能平台管理接口（IPMI）、RedFish、通用即插即用（UPNP）等，以及设备通信协议，包括安全协议与数据模型 (SPDM)。<br>4) 管理模式或可信世界模糊测试可用于管理模式或可信世界通信缓冲区及管理模式中断（MMI）处理程序，例如X86系统管理模式（SMM）或ARM TrustZone，特别是用于通信的软件管理模式中断。<br>5) 可采用数据特定模糊测试，例如UEFI/PI BIOS的UEFI变量数据、S3唤醒的PI启动脚本数据、平台信任根模块的启动策略清单(BPM)、动态信任根模块(DRTM)的ACPI表等。<br>侧信道攻击<br>1) 若管理模式或可信环境包含机密信息，检查管理模式处理程序是否采用侧信道防护最佳实践，例如Spectre防护机制。<br>2) 若内核模式包含机密信息，检查内核处理程序是否采用侧信道防护最佳实践，例如Spectre和Meltdown防护机制。
| 竞争条件 | 检查时间/使用时间攻击<br>1) 针对管理模式或可信世界通信缓冲区的TOC/TOU攻击。<br>2) 针对固件更新工具使用的数据缓冲区的TOC/TOU攻击。3) 针对经平台信任根验证后的闪存固件镜像的TOC/TOU攻击。<br>多处理器的竞争条件。<br>1) 使一个处理器进入管理模式或可信环境以解锁寄存器，并让另一个处理器利用解锁后的系统状态，例如闪存解锁。|
| 硬件输入 | 模糊测试硬件输入<br>1) 模糊测试模块访问的硅寄存器，例如内存映射I/O（MMIO）、I/O、PCI配置空间、X86特定模型寄存器（MSR）等。<br>2) 模糊测试设备信息，例如USB描述符、蓝牙低功耗广播数据、内存DIMM串行存在检测(SPD)数据等。<br>3) 模糊测试总线通信，例如串行外设接口(SPI)总线、集成电路间总线(I2C)、系统管理总线(SMBus)、USB总线等。<br>基址寄存器（BAR）重叠。<br>1) 重叠高权限MMIO区域（例如Intel虚拟化技术中的定向I/O配置或串行外设接口SPI闪存配置）与低权限MMIO区域（例如传统PCI Express配置空间）。<br>2) 重叠关键内存区域（例如系统管理SRAM）与低权限MMIO区域（例如传统PCI Express配置空间）。<br>DMA攻击<br>1) 尝试生成指向系统内存的DMA事务以注入代码。<br>2) 尝试生成指向系统内存的DMA事务以窃取机密数据。<br>缓存攻击<br>对管理模式代码实施缓存攻击。<br>意外断电<br>1) 在系统更新新固件镜像时，尝试通过意外断电引发部分更新。<br>2) 当系统更新配置（例如UEFI变量）时，尝试通过意外断电引发部分更新。<br>3) 尝试通过意外断电窃取操作系统内存中的机密信息，观察下次启动时内存内容是否被清除。<br>4) 尝试通过意外断电从TCG存储保护区域中窃取操作系统机密，观察下次启动时是否触发TPer重置。<br>机架入侵<br>1) 清除CMOS来回滚到默认配置。<br>2) 设置硬件跳线来触发特殊启动模式，例如恢复或制造模式。<br>3) 在平台上添加或替换恶意硬件设备，例如PCI卡，内存DIMM等。<br>4) 更新板载恶意设备固件，例如PCI设备固件，内存DIMM固件等。<br>其他设备攻击<br>1) 通过持续写入新配置数据对SPI闪存执行磨损攻击。<br>2) DRAM的行锤攻击。<br>3) DRAM的差错攻击。<br>|
| 秘密处理 | 用户密码认证<br>1) 在键盘缓冲区中搜索密码。<br>2) 在管理模式通信缓冲区中搜索密码。<br>3) 在系统内存中搜索密码，例如栈、堆或镜像全局数据区。<br>4) 在系统非易失性存储器中搜索密码，例如UEFI变量存储区。<br>5) 密码应同时以ASCII格式和Unicode格式进行搜索。<br>弱密码实现<br>1) 检查密码是否在非易失性存储器中经过正确哈希处理，而非以异或运算方式存储于已知值。2) 检查非易失性存储器是否可未经授权进行更新。<br>3) 检查是否使用了足够长度的盐值。<br>4) 检查是否强制执行强密码策略。<br>5) 检查是否设置密码重试次数限制。<br>6) 检查是否提供忘记密码选项。<br>7) 尝试清除CMOS后触发恢复制造模式流程，验证密码是否仍为必需。<br>8) 检查是否存在预设默认密码或作为后门的超级密码。<br>硬驱密码<br>1) 尝试绕过硬盘密码和TCG存储密码。<br>2) 尝试冻结硬盘密码或TCG存储SID，尤其在特殊启动路径中（例如S3唤醒、恢复模式或制造模式）。<br>3) 尝试窃取存储在管理模式和/或非易失性存储中的硬盘密码或TCG存储密码。<br>4) 通过比较错误退出时间尝试窃取密码信息。<br>网络凭证<br>1) 尝试窃取部署的WIFI密码，作为预共享密钥（PSK）或企业模式的明文证书。<br>2) 尝试窃取部署的TLS或IPSec的明文的私有证书。<br>设备访问<br>1) 检查设备是否存在硬编码访问代码，例如EC或电池。<br>2) 检查系统内存（如栈、堆、全局数据区域等）或非易失性存储器（如UEFI变量）中是否存在预配置的访问代码。<br>3) 检查系统内存或非易失性存储中是否存在预配置的RPMB密钥。<br>4) 检查系统内存或非易失性存储中是否存在预配置的RPMC密钥。<br>加密密钥<br>1) 检查处理后内存中是否残留对称密钥，例如AES密钥、HMAC密钥等。<br>2) 检查处理后内存中是否残留任何非对称密钥，例如RSA私钥、保护私钥的密码等。<br>3) 检查密钥在从提供者到消费者的所有路径中是否被清除，包括栈、堆、全局变量、通信缓冲区等。<br>侧信道攻击<br>1) 尝试窃取存储在管理模式RAM中的密码。|
| 寄存器锁定 | 漏洞扫描<br>1) 运行CHIPSEC扫描工具，检查所有可锁定寄存器是否确实处于锁定状态，特别是闪存锁定和管理模式锁定。<br>2) 在特殊启动模式下运行CHIPSEC扫描工具（如S3唤醒、S4唤醒、恢复模式甚至制造模式），以验证终端用户是否能触发制造模式重启。|
| 安全配置 | 破坏安全启动策略<br>1) 尝试禁用安全启动，例如通过UEFI变量实现。<br>2) 尝试在特殊启动模式下绕过安全启动验证，例如S3唤醒、S4唤醒、恢复模式或制造模式。<br>3) 尝试未经授权修改已注册的公钥证书。<br>4) 尝试未经授权删除已注册的禁止公钥证书。<br>破坏可信计算组策略<br>1) 尝试禁用测量启动功能。例如，在设置选项或UEFI变量中禁用TPM。<br>2) 尝试在启动后访问TPM平台层次结构认证，尤其是在特殊启动模式下，例如S3、S4、恢复模式、制造模式等。<br>3) 尝试在不向TPM发送关机命令的情况下挂起系统，以观察TPM设备能否在S3唤醒时正常复原。<br>4) 触发TPM S3唤醒失败，观察PCR是否未被限制。<br>5) 通过清除MOR变量尝试禁用TCG内存覆盖(MOR)功能。<br>6) 尝试更新TCG物理存在标志配置，尤其在特殊启动模式下（例如S4唤醒、恢复模式、制造模式），例如当标志配置存储于非易失性存储器时。<br>检查完整性。<br>1) 对于安全启动，检查是否对所有第三方组件进行验证。评估未受信任闪存分区中的镜像、磁盘上的镜像、PCI卡中的镜像、来自网络的镜像、恢复介质中的镜像等。<br>2) 对于安全启动，检查是否在所有启动模式下进行验证，特别是S3唤醒、S4唤醒、恢复模式、制造模式等。<br>3) 对于静态测量信任根（SRTM），需检查所有关键代码与关键配置是否均被测量至TPM。需排查未被测量的代码（如固件支持包FSP）、未被测量的数据（如ACPI表或SMBIOS表），以及未被测量的安全策略（如公有证书或安全启动启用/禁用状态）。<br>4) 对于动态测量信任根（DRTM），同样需验证完整性。是否存在未被测量的DRTM代码/数据/策略？S3唤醒阶段是否执行相同测量？<br>5) 对于内存保护，需检查所有应受保护的内存是否确实受到保护，特别是特殊内存区域，例如4GiB以上的内存、1MiB以下的内存以及未经测试的内存。所有可信世界的内存是否受保护？所有内核内存是否受保护？<br>6) 对于系统资源保护，需检查所有应受保护的资源是否均确实受到保护，包括内存映射I/O、I/O、模型特定寄存器(MSRs)、PCI配置空间、嵌入式控制器(EC)配置、系统管理总线(SMBus)、集成电路间总线(I2C)、串行外设接口(SPI)总线等。<br>破坏恢复过程<br>1) 尝试删除优质的恢复镜像。<br>2) 尝试修改或用恶意镜像替换优质的恢复镜像。<br>触发制造模式<br>1) 尝试查看制造模式下是否可禁用任何保护机制，包括但不限于安全启动、测量启动、用户认证、UEFI变量保护等。<br>破坏其他高级保护<br>1) 尝试禁用DMA保护或降低其保护级别，例如通过设置选项或UEFI变量。<br>2) 尝试禁用内核强化策略，例如地址空间布局随机化和数据执行保护。|
| 重放/回滚 | 回滚固件代码<br>1) 在固件更新过程中尝试回滚至安全版本号（SVN）较低的旧固件镜像。<br>2) 在SPI闪存更新时回滚至SVN较低的旧固件镜像，观察其能否被安全启动流程检测到。<br>3) 尝试将优质的恢复镜像回滚至SVN较低的版本。<br>回滚固件配置<br>1) 在配置数据更新过程中尝试回滚至某些不安全的旧系统配置数据。<br>2) 通过直接更新SPI闪存回滚至某些不安全的旧系统配置，观察是否能被检测到。<br>3) 触发特殊启动模式（例如恢复模式或制造模式），观察配置是否回滚至不安全状态，如旧版安全启动密钥。<br>4) 捕获旧配置数据，并在后续时间点重放该旧配置数据。|
| 加密学 | 模糊测试输入<br>1) 模糊测试数字签名，包括格式错误的签名和无签名的情况。证书模糊测试工具可用于处理加密编码，例如X.509证书、抽象语法标记法1（ANS.1）、简洁二进制对象表示法（CBOR）等。<br>2) 模糊测试数据结构包裹的签名，例如证书字段前的PE镜像、签名区段前的固件卷(FV)头部、固件管理协议(FMP)胶囊认证信息前的UEFI胶囊头部。<br>3) 模糊测试协议，例如传输层安全协议(TLS)和安全协议与数据模型(SPDM)。<br>加密算法<br>1) 检查固件镜像更新和恢复是否使用非加密算法，例如异或（XOR）、循环冗余校验（CRC）或校验和。<br>2) 检查设备固件更新是否采用加密算法进行验证，包括但不限于基板管理控制器（BMC）固件、嵌入式控制器（EC）固件、管理引擎（ME）固件、PCI设备固件、内存DIMM固件等。<br>3) 检查是否使用任何已弃用的算法，例如MD5、SHA1、DES、ECC和P256K1。<br>4) 检查是否使用非标准加密算法或协议，例如使用定制化加密-消息认证码（E&M）、加密后-消息认证码（EtM）或消息认证码-后加密（MtE）方案替代标准的关联数据认证加密（AEAD）。<br>5) 检查密钥长度是否足够。<br>6) 检查密钥交换算法是否考虑了前向安全性。<br>7) 检查随机种子是否真正具有均匀随机性。<br>8) 检查序列号、计数器、随机数值和初始化向量是否正确使用。例如，序列号或计数器不能从0开始，初始化向量必须是随机的。<br>9) 检查随机数生成函数是否符合标准。<br>攻击密钥<br>1) 尝试窃取内存或非易失性存储器中的私钥。<br>2) 尝试窃取内存或非易失性存储器中的对称密钥。<br>3) 尝试在未经授权的情况下修改已部署的公有证书或其哈希值。<br>5) 尝试在未经授权的情况下删除已部署的撤销密钥。<br>6) 尝试在特殊启动模式（如恢复模式或制造模式）中窃取密钥。<br>降级协议版本和算法<br>1) 尝试与实体协商，将协议降级至较低且已知存在漏洞的版本。出于兼容性考虑，某些实现可能支持旧版协议，例如TLS 1.0和TLS 1.1。<br>2) 尝试与实体协商，将算法降级至已弃用的版本。出于兼容性考虑，某些实现可能支持已弃用的算法，例如SHA1。<br>密码学使用<br>1) 检查测试密钥是否用于生产环境。<br>2) 检查是否有方法撤销证书。<br>3) 检查是否使用根密钥而非会话密钥加密数据。<br>4) 检查公有证书链是否依据受信任根证书或其哈希值进行验证，同时核查撤销证书或其哈希值。<br>5) 检查证书有效期是否经过验证。<br>6) 检查请求的主机名是否依据证书的通用名进行验证。|

这是必要的，但还不够充分。完整的安全验证计划应基于详细的功能特定安全要求来制定。

