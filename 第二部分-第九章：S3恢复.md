## 第九章

# S3恢复

高级配置与电源接口（ACPI）规范定义了一组电源状态（见图9-1）。这些电源状态包括以下内容：

    • G0 (S0) —— 工作状态：运行中的固件或操作系统处于S0状态。
    • G1 —— 睡眠状态
        • S1 —— 待机：除了CPU缓存，所有的系统上下文都保留。所有CPU都停止运行。其他设备仍处于工作状态。当系统暂停时，系统从下一条指令开始恢复。
        • S2 —— 与S1类似：目前未使用。
        • S3 —— 暂停至内存：系统上下文保存到平台内存。设备停止工作。只刷新DRAM来保留内容。系统从固件复位向量恢复，并跳转到操作系统唤醒向量。之后，操作系统从内存中恢复上下文。当用户选择“睡眠”选项，系统进入S3状态。这也可以由某些操作启动，例如关闭笔记本的盖子。
        • S4 —— 暂停至磁盘：系统上下文保存到磁盘中。所有设备停止工作。系统从固件复位向量恢复，并以正常启动方式启动操作系统。之后 操作系统从磁盘恢复上下文。当用户选择“休眠”选项时，系统会进入S4状态。
        • 有一个名为S4 BIOS的选项，这意味着BIOS保存内存的副本到磁盘，然后启动硬件S4。当系统唤醒时，固件会从磁盘恢复内存，并通过将控制权转移到操作系统唤醒向量来唤醒操作系统。如今，大多数平台都不采用这种方式，因为这是早期高级电源管理（APM）的一种独立于操作系统的技术。
    • G2 (S5) —— 软关闭状态：当用户选择“关闭”选项时，系统进入S5状态。
    • G3 —— 电源关闭状态：当用户选择关闭机器电源时，机器处于G3状态。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-1.jpg></img></div>
<div align=center>图 9-1 整体系统电源状态与过渡（来源：ACPI规范）</div>

系统固件参与Sx的暂停和恢复。S1恢复由操作系统内部直接处理。S4恢复和S5恢复与正常启动类似。S3恢复是一种特殊的启动路径，与正常启动路径有很大不同。这些差异带来了独特的安全挑战，我们将在本章重点讨论。

## 威胁模型

S3意味着"暂停到内存"。操作系统的上下文在内存中，某些固件S3的上下文也在内存中。如果恶意代码可以访问S3恢复中使用的操作系统或固件S3的上下文，则可能会影响系统的机密性、完整性和可用性。

S3恢复的资产如表9-1所示。这些资产包括但不限于闪存内容、内存内容、硅片寄存器设置、TPM设备状态和存储设备配置。这些资产可能需要完整性、可用性或保密性属性。

表 9-1 S3恢复资产
| 资产 | 完整性 | 可用性 | 机密性 |
| :--- | :--- | :--- | :--- | 
| 闪存 | 固件代码 固件配置 | 固件代码 固件配置 | 无 |
| 内存 | SMRAM | 操作系统唤醒向量 | SMRAM |
| 硅片 | 锁存寄存器 | 硅片寄存器 内存配置数据 | 无 |
| TPM状态 | TPM2平台层次 | TPM设备状态 | 无 |
| 存储磁盘 | TCG存储块SID HDD冻结 | 无 | 磁盘密码 |

