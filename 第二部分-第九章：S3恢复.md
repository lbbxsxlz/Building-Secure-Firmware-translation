## 第九章

# S3恢复

高级配置与电源接口（ACPI）规范定义了一组电源状态（见图9-1）。这些电源状态包括以下内容：

    • G0 (S0) —— 工作状态：运行中的固件或操作系统处于S0状态。
    • G1 —— 睡眠状态
        • S1 —— 待机：除了CPU缓存，所有的系统上下文都保留。所有CPU都停止运行。其他设备仍处于工作状态。当系统暂停时，系统从下一条指令开始恢复。
        • S2 —— 与S1类似：目前未使用。
        • S3 —— 暂停至内存：系统上下文保存到平台内存。设备停止工作。只刷新DRAM来保留内容。系统从固件复位向量恢复，并跳转到操作系统唤醒向量。之后，操作系统从内存中恢复上下文。当用户选择“睡眠”选项，系统进入S3状态。这也可以由某些操作启动，例如关闭笔记本的盖子。
        • S4 —— 暂停至磁盘：系统上下文保存到磁盘中。所有设备停止工作。系统从固件复位向量恢复，并以正常启动方式启动操作系统。之后 操作系统从磁盘恢复上下文。当用户选择“休眠”选项时，系统会进入S4状态。
        • 有一个名为S4 BIOS的选项，这意味着BIOS保存内存的副本到磁盘，然后启动硬件S4。当系统唤醒时，固件会从磁盘恢复内存，并通过将控制权转移到操作系统唤醒向量来唤醒操作系统。如今，大多数平台都不采用这种方式，因为这是早期高级电源管理（APM）的一种独立于操作系统的技术。
    • G2 (S5) —— 软关闭状态：当用户选择“关闭”选项时，系统进入S5状态。
    • G3 —— 电源关闭状态：当用户选择关闭机器电源时，机器处于G3状态。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-1.jpg></img></div>
<div align=center>图 9-1 整体系统电源状态与过渡（来源：ACPI规范）</div>

系统固件参与Sx的暂停和恢复。S1恢复由操作系统内部直接处理。S4恢复和S5恢复与正常启动类似。S3恢复是一种特殊的启动路径，与正常启动路径有很大不同。这些差异带来了独特的安全挑战，我们将在本章重点讨论。

## 威胁模型

S3意味着"暂停到内存"。操作系统的上下文在内存中，某些固件S3的上下文也在内存中。如果恶意代码可以访问S3恢复中使用的操作系统或固件S3的上下文，则可能会影响系统的机密性、完整性和可用性。

S3恢复的资产如表9-1所示。这些资产包括但不限于闪存内容、内存内容、硅片寄存器设置、TPM设备状态和存储设备配置。这些资产可能需要完整性、可用性或保密性属性。

表 9-1 S3恢复资产
| 资产 | 完整性 | 可用性 | 机密性 |
| :--- | :--- | :--- | :--- | 
| 闪存 | 固件代码 固件配置 | 固件代码 固件配置 | 无 |
| 内存 | SMRAM | 操作系统唤醒向量 | SMRAM |
| 硅片 | 锁存寄存器 | 硅片寄存器 内存配置数据 | 无 |
| TPM状态 | TPM2平台层次 | TPM设备状态 | 无 |
| 存储磁盘 | TCG存储块SID HDD冻结 | 无 | 磁盘密码 |

S3恢复攻击者可以使用软件攻击（例如编写代码修改系统上下文）或硬件攻击（例如使用闪存编程器访问闪存区域、使用设备执行DMA攻击并触发断电）。攻击面可以是闪存访问、内存访问、硅寄存器或TPM命令。有关S3攻击面，见表9-2。

表 9-2 S3攻击面
| 攻击面 | 软件攻击 | 硬件攻击 |
| :--- | :--- | :--- |
| 闪存访问 | 读/写配置（变量）| 固件代码 固件配置 |
| 内存访问 | ACPI非易失性存储（NVS） ACPI保留内存 | ACPI非易失性存储（NVS） ACPI保留内存 |
| 硅寄存器 | 读/写硅寄存器（I/O，MMIO，PCI）| 无 |
| TPM命令 | TPM设备状态（关闭命令）| 无 |

攻击可能在S3暂停期间（例如修改操作系统中的ACPI内存、发送恶意TPM命令或不发送特定TPM命令）、处于S3状态（例如使用闪存编程器更新固件代码）或S3恢复期间（例如附加恶意的PCI设备进行DMA访问）发生。

为了缓解这些攻击，S3恢复实现应采取防御措施。见表9-3。有些S3缓解措施与正常启动中使用的类似，例如在S3中验证闪存映像，以及设置IOMMU或其他DMA保护以抵御S3中的DMA攻击。有些S3缓解措施针对特定设备，例如保留TPM设备状态。这些技术已在前几章中讨论过。S3缓解措施的一个主要类别是安全存储，用于保存S3恢复时使用的设置，包括：1）内存中的CPU配置数据，例如CPU状态、SMM环境——页表和SMBASE；2）硅寄存器配置数据，例如芯片组和PCI Express设备的寄存器设置；3）设备配置数据，例如TCG存储BlockSID状态和硬盘解锁密码。我们将这类安全存储称为锁箱（LockBox）。

表 9-3 S3攻击缓解措施
| 资产 | 预防 | 检测 | 恢复 |
| :--- | :--- | :--- | ：--- |
| 闪存 | 闪存设备锁 变量锁/认证 | S3中的闪存镜像验证 变量检查/RPMC | 切换到正常启动去恢复 |
| 内存 | S3中的IOMMU 保存数据到锁箱 | 电源损失检测 | 切换到正常启动 |
| 硅 | 保存配置数据到锁箱 代码中的寄存器锁 | 无 | 无 |
| TPM状态 | 发送TPM2_HierarchyChangeAuth() | 检查TPM2_Startup() | 覆盖PCR |
| 存储磁盘 | 保存配置数据到锁箱 | 无 | 无 |

## 锁箱

锁箱是用于S3恢复期间的安全存储抽象。在正常启动或S3暂停阶段，授权的固件组件保存当前的配置到锁箱中。在S3恢复阶段，授权固件组件会从锁箱中检索配置、配置系统并启动到操作系统唤醒向量。见图 9-2。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-2.jpg></img></div>
<div align=center>图 9-2 在S3恢复中的锁箱用法</div>

锁箱可以提供机密性、完整性和可用性支持。出于机密性考虑，只有被授权的实体才能读取锁箱内容。对于完整性，只有被授权的实体才能往锁箱写入内容。对于可用性考虑，锁箱应始终存在。要防止硬件攻击是很困难的，因为硬件攻击可能包括只断电破坏内存内容或使用闪存编程器擦除闪存内容。

平台有很多实现锁箱的选择，包括但不限于可信执行环境（TEE），例如系统管理模式（SMM）、UEFI变量（使用变量锁实现完整性和加密变量实现保密性）、TPM非易失性存储，或基于协处理器的机制，例如英特尔聚合安全和管理引擎（CSME）、AMD平台安全处理器（PSP）、服务器基板管理控制器（BMC）等。锁箱实现选择的总结见表9-4。

表 9-4 S3锁箱实现
| 机制 | 完整性 | 可用性 | 机密性 | 注释 |
| :--- | :--- | :--- | ：--- | ：--- |
| TEE(SMM) | 是 | 对于软件攻击，是；对于硬件攻击，否 | 是 | 在内存初始化之前可能不支持 |
| 变量 | 需要变量锁或认证 | 对于软件攻击，是；对于硬件攻击，否 | 需要加密变量 | 闪存大小限制 |
| TPM NV | 需要认证会话或锁 | 是 | 需要认证会话 | TPM设备依赖，NV大小限制 |
| 协处理器 | 是 | 是 | 是 | 协处理设备依赖 |

## 案例研究

现在，让我们看一下锁箱实现的一些真实的使用案例。

### 基于TEE的锁箱

S3恢复过程的目标是将平台恢复到启动前的配置。UEFI PI架构仍需分阶段恢复平台，就像在正常启动路径中一样。图9-3显示了S3恢复启动路径中的各个阶段。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-3.jpg></img></div>
<div align=center>图 9-3 PI架构S3恢复启动路径</div>

在正常启动中，PEI阶段负责初始化足够的平台资源，来执行DXE阶段，而DXE阶段是由不同的DXE驱动程序执行大部分平台配置的阶段。

在S3恢复阶段，引入DXE并使DXE驱动程序启动路径感知是非常危险的，原因如下：

    • DXE 阶段承载了大量服务，因此规模相当大。
    • 从闪存加载 DXE 非常耗时。

相反，PI架构提供的启动脚本可让S3恢复启动路径完全规避DXE阶段，这有助于最大限度地提高S3恢复性能。启动脚本是一组条目，例如IO_WRITE(端口、数据)、MMIO_WRITE(地址、数据)和PCI_WRITE(段、总线、设备、功能、寄存器、数据)。这是一种配置硅寄存器的轻量级方法。在正常启动过程中，例如从S5启动时，DXE驱动程序会在启动脚本中记录平台配置，并保存在NVS中。在S3恢复启动路径期间，启动脚本引擎会执行脚本，从而恢复配置。

ACPI规范只要求BIOS恢复芯片组和处理器配置。芯片组配置可视为DXE驱动程序在PI架构启动脚本中记录的一系列内存、I/O和PCI配置操作。在S3恢复期间，启动脚本引擎会执行启动脚本以恢复芯片组设置。

正常启动时，启动脚本的保存方式如下：

1) 在DXE阶段，芯片/平台驱动程序将寄存器配置保存到启动脚本中。这就是启动时的S3脚本。
2) 在SMM阶段，硅/平台驱动程序可以继续将寄存器配置保存到表中，即使在操作系统运行期间也是如此。典型的实现是，当操作系统触发进入S3时，系统进入SMM。一个特殊的SMI处理程序会收集运行时硅寄存器设置（如PCI配置），并将信息保存到启动脚本中。这就是运行时S3脚本。

在S3恢复期间，启动脚本的执行过程如下：

3) 在PEI中，启动脚本执行引擎会获取启动脚本并重播保存的启动脚本，以恢复系统配置。启动时S3脚本和运行时S3脚本都会被执行。

实际上，启动脚本庞大，因为它包含来自芯片组和PCI Express设备的所有硅设置。将启动脚本保存到UEFI变量或TPM NV并不总是可行的，因为TPM或闪存的可使用的存储空间有限。使用SMM环境是一种架构解决方案，它被EDK II BIOS使用来实现基于SMM的锁箱，并作为默认的启动脚本。

除了启动脚本的使用，我们也需要将硬盘密码保存到锁箱中，来自动解锁磁盘。因此，基于SMM的锁箱需要同时考虑完整性和保密性。

一种基于SMM的锁箱的完整性规则如下：

    • 在SmmReadyToLock事件发生之前，任何驱动程序都可以使用DXE锁箱或SMM锁箱接口将信息保存到锁箱中。还支持从锁箱中恢复信息，尽管很少使用。
    • 在SmmReadyToLock事件发生后，DXE代码不再受信任。通过DXE代码将信息保存到锁箱的尝试将被拒绝。SMM代码已经可用，并可以使用SMM锁箱保存运行时启动脚本。
    • 在S3恢复期间，无需将信息保存到锁箱中。因此，PEI锁箱不提供将信息保存到锁箱的功能。

根据这些规则，只有平台制造商的代码才能将信息保存到锁箱中。第三方代码不能将信息保存到锁箱中。

一种基于SMM的锁箱的机密性规则如下：

    • 默认情况下，锁箱不提供任何机密性支持。DXE/PEI/SMM实例可以恢复锁箱内容。
    • 如果锁箱需要机密性，创建者需要设置为锁箱设置LOCK_BOX_ATTRIBUTE_RESTORE_IN_S3_ONLY属性。
    • 如果LOCK_BOX_ATTRIBUTE_RESTORE_IN_S3_ONLY属性设置，此锁箱只能被恢复
        • 在SmmReadyToLock事件之前（或）
        • 在系统进入S3（S3Entry事件）和S3恢复结束（EndOfS3恢复事件）之间

根据此规则，机密只能在平台退出平台制造商认证阶段或固件恢复阶段之前恢复。第三方代码不能从锁箱恢复机密。

在EDK II，锁箱提供了如下的服务：

    1）SaveLockBox()：发送数据到锁箱。锁箱可以由全球唯一标识符（GUID）唯一地识别。
    2）UpdateLockBox()：更新锁箱中地数据。
    3）SetLockBoxAttributes()：设置锁箱属性。
        a) LOCK_BOX_ATTRIBUTE_RESTORE_IN_PLACE意味着这个锁箱能使用RestoreAllLockBoxInPlace()恢复到它原来的地址。
        b) LOCK_BOX_ATTRIBUTE_RESTORE_IN_S3_ONLY意味着这个锁箱能在S3恢复路径中恢复。这用来提供机密性支持。
    4）RestoreLockBox()：从锁箱中获取数据给调用者提供的缓冲区地址或原始的缓冲区地址。
    5）RestoreAllLockBoxInPlace()：从所有的拥有LOCK_BOX_ATTRIBUTE_RESTORE_IN_PLACE属性的锁箱中恢复数据。

并非所有的锁箱服务在所有的BIOS阶段都可用。全部概要显示在图9-4。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-4(1).jpg></img></div>
<div align=center>图 9-4(1) 在（正常启动）每个阶段的基于SMM的锁箱功能</div>

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-4(2).jpg></img></div>
<div align=center>图 9-4(2) 在（S3）每个阶段的基于SMM的锁箱功能</div>

S代表锁箱保存。
R代表锁箱恢复。
RS代表锁箱恢复机密。
