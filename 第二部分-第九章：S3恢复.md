## 第九章

# S3恢复

高级配置与电源接口（ACPI）规范定义了一组电源状态（见图9-1）。这些电源状态包括以下内容：

    • G0 (S0) —— 工作状态：运行中的固件或操作系统处于S0状态。
    • G1 —— 睡眠状态
        • S1 —— 待机：除了CPU缓存，所有的系统上下文都保留。所有CPU都停止运行。其他设备仍处于工作状态。当系统暂停时，系统从下一条指令开始恢复。
        • S2 —— 与S1类似：目前未使用。
        • S3 —— 暂停至内存：系统上下文保存到平台内存。设备停止工作。只刷新DRAM来保留内容。系统从固件复位向量恢复，并跳转到操作系统唤醒向量。之后，操作系统从内存中恢复上下文。当用户选择“睡眠”选项，系统进入S3状态。这也可以由某些操作启动，例如关闭笔记本的盖子。
        • S4 —— 暂停至磁盘：系统上下文保存到磁盘中。所有设备停止工作。系统从固件复位向量恢复，并以正常启动方式启动操作系统。之后 操作系统从磁盘恢复上下文。当用户选择“休眠”选项时，系统会进入S4状态。
        • 有一个名为S4 BIOS的选项，这意味着BIOS保存内存的副本到磁盘，然后启动硬件S4。当系统唤醒时，固件会从磁盘恢复内存，并通过将控制权转移到操作系统唤醒向量来唤醒操作系统。如今，大多数平台都不采用这种方式，因为这是早期高级电源管理（APM）的一种独立于操作系统的技术。
    • G2 (S5) —— 软关闭状态：当用户选择“关闭”选项时，系统进入S5状态。
    • G3 —— 电源关闭状态：当用户选择关闭机器电源时，机器处于G3状态。

<div align=center><img src=Figures/Chapter-9-Screenshot/Figure-9-1.jpg></img></div>
<div align=center>图 9-1 整体系统电源状态与过渡（来源：ACPI规范）</div>

系统固件参与Sx的暂停和恢复。S1恢复由操作系统内部直接处理。S4恢复和S5恢复与正常启动类似。S3恢复是一种特殊的启动路径，与正常启动路径有很大不同。这些差异带来了独特的安全挑战，我们将在本章重点讨论。
