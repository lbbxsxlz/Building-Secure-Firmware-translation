## 第三章

# 固件弹性：保护

固件弹性包括三个元素：保护、检测和恢复。保护是指保护固件组件免受攻击。保护是固件弹性的一个主动方面，而检测和恢复是被动机制。对于弹性而言，主要威胁来自软件攻击者和硬件攻击者。

## 弹性构建块

弹性构建块包括三个部分：

    1） 弹性目标：它是可改变的引擎，包括代码和数据。
    2） 弹性引擎：为弹性目标提供服务的不可改变的引擎，例如保护、验证、更新或恢复。
    3） 弹性授权机构：授权弹性引擎在弹性目标上执行服务的实体。

在弹性引擎内部存在三个主要块：

    1） 安全执行环境（SEE）：这是一个安全的执行立足点来确保一个妥协的弹性目标不会影响恢复。
    2） 保护锁存，例如写入锁和读取锁：这是为了确保在弹性引擎中的永久的储存不能被妥协的弹性目标篡改。
    3） 看门狗计时器：这是为了确保妥协的弹性目标不能影响弹性引擎执行恢复动作。

图3-1显示了弹性构建块。

<div align=center><img src=Figures/Figure-3-1.jpg></img></div>
<div align=center>图 3-1 弹性构建块</div>

为了支持关键弹性，我们需要定义一组信任根（RoTs）。这些信任根包括更新信任根（RTU）、检测信任根（RTD）、恢复信任根（RTRec）。一些功能也能在锚定在信任根中的信任链（CoT）中实现。我们也需要定义相关的更新信任链（CTU）、检测信任链（CTD）和恢复信任链（CTRec）。那些弹性信任根（RTRes）在弹性引擎中，并且提供服务，例如保护与更新、检测和恢复。我们将在第3、4和5章中逐一讨论。

一个平台可能有不同的固件组件。我们做了如下分类：

    • 不可改变的ROM（包括代码和数据）
    • 可更新的固件（包括代码和数据）
    • 配置数据

基于这些分类，我们可能使用不同的保护机制。

## 不可改变的ROM

一个不可改变的ROM在系统中是不能升级的逻辑。它被认为是信任根（RoT）。不可改变的ROM包括代码和数据。通常，不可改变的ROM的范围应该足够小，以便于审查与审计，以确保无bug。其优点是保护策略很简单 —— ROM必须永远锁定。其缺点是一旦发现在不可改变的ROM中发现安全问题，没有机会去修复，并且设备应该被丢弃。

### 完整性

基本的安全要求是ROM的完整性。一旦ROM被锁定，没有人可以写入它。通常，这种保护是由硬件端完成，以防止软件攻击。但我们也需要考虑硬件攻击。硬件攻击者可能劫持平台上的系统总线来绕过保护。平台可能锁定SPI控制器中的串行外围接口（SPI）闪存区块。因此，没有人可以向SPI设备发送命令，但硬件攻击者可能直接对SPI芯片添加闪存编程器，并且对整个SPI芯片烧录。或者硬件攻击者可能会附加一个额外的SPI芯片来提供备用代码和数据。作为一种缓解措施，平台需要确保ROM在平台内部，并且不暴露任何可编程接口。

### 机密性

机密性也需要考虑。如果不可改变的ROM包括私钥，则密钥任何时候都不得暴露。根据Kerckhoffs原则，除了私钥之外，整个不可改变的ROM都可以暴露。对于高度关键的设备或系统，整个不可改变的ROM也需要加密或不能被外部读取，因为保证ROM机密可以使破坏设备或系统变得困难。内部细节只能出于审计目的公开。

### 案例研究

现在，让我们看看不可改变的ROM的一些真实案例。

#### 移动、桌面和服务器中的不可改变的ROM

不可改变的ROM可能存在于个人的计算机或服务器中。片上ROM中的X86 CPU微代码是不可改变的。会有CPU微代码更新在运行时通过补丁RAM来修补微代码，但是基本的芯片内部的CPU微代码是不可改变的。

平台可能设计一个单独的芯片作为信任根（RoT）。芯片上的不可改变的ROM验证系统固件和一些设备固件，因此，它创建了信任链（CoT）。例子包括谷歌设计的Titan芯片、苹果设计的T2芯片、AMD设计的AMD平台安全处理器、开源计算项目（OCP）定义的Cerberus安全架构和英特尔的平台固件弹性（PFR）。一个传统的X86系统见图3-2。这信任根固件验证主要的BIOS和关键启动固件，例如管理引擎（ME）固件，服务器的基板管理控制器（BMC）固件和客户端系统的嵌入式控制（EC）固件。然后主要的BIOS验证非关键启动固件（例如非易失性存储接口（NVMe）固件，传感器固件和音频固件）。

<div align=center><img src=Figures/Figure-3-1.jpg></img></div>
<div align=center>图 3-2 移动、桌面和服务器中的平台组件</div>

我们将在第4章讨论信任根和信任链的更多细节。

#### 嵌入式和物联网（IoT）领域中的不可改变的ROM

在嵌入式领域，ARM为A系列（应用处理器，AP）和M系列（微控制器）定义了平台安全架构（PSA）来提供针对物联网（IoT）设备的指南。平台安全架构的信任根包括硬件和不可改变的固件。A系列的可信固件（Trusted-Firmware-A）是针对ARM系统A系列可信固件设计的参考实现（见图3-3）。可信的ROM是不可改变的固件。上电时，应用处理器（AP）在重置向量执行可信的ROM。然后可信的ROM验证并加载可信固件。可信固件验证和加载运行时固件的额外部分和非安全固件。可信固件可能也验证系统控制处理器（SCP）固件如果它存在。

<div align=center><img src=Figures/Figure-3-3.jpg></img></div>
<div align=center>图 3-3 ARM A系列中的平台组件</div>

M系列的可信固件（Trusted-Firmware-M）是针对ARM系统M系列可信固件设计的参考实现（见图3-4）。因为微控制器（MC）只有受限的于执行环境，其启动流程就简单的多。微控制器在重置向量执行MCUBoot ROM。MCUBOOT验证所有重置的固件包括安全固件的安全分区管理（SPM）和非安全的固件。

<div align=center><img src=Figures/Figure-3-4.jpg></img></div>
<div align=center>图 3-4 ARM M系列中的平台组件</div>

我们将在第4章更详细地讨论平台安全架构。

#### 特别的恢复镜像

通常，系统固件没有不可改变的部分。为了修复安全问题，所有的固件必须可升级。唯一可能的例外称之为特别的恢复镜像。特别的恢复镜像是当系统固件不能启动时仅用在恢复阶段的固件。然而，制作不可改变的特别的恢复镜像是非常危险的。在特别的系统固件中任何安全漏洞都会成为致命弱点（阿喀琉斯之踵）。如果这类安全漏洞被暴露，所有的攻击者需要做的是在更新期间移除电源来触发恢复过程。然后他们能攻击特别的恢复镜像。

我们将在第5章中讨论恢复处理的更多细节。

### 攻击与缓解

现在，让我们看一下针对不可改变的ROM和可能的缓解措施的一些真实的案例。

#### 机密

不可改变的ROM可能包含机密 —— 平台的根密钥用来派生密钥的支撑物或用来证明身份的私钥。这机密不能以任何方式暴露。例如，如果机密保存在外部的非易失性存储或暴露在类似DRAM或SPI总线等总线上，则可能意味着风险。

## 可升级的固件

通常，系统固件是可升级的。平台制造商可能发布新的固件来修复功能性问题或安全问题。板子上的任一设备固件是可升级的。这新的设备固件可能是设备制造商发布的独立包或是集成到平台制造商整个系统更新包的一部分。

根据NIST SP800-193，可升级固件的保护基于三个原则：

    • 已验证的更新机制
    • 完整性保护
    • 不可绕过

### 已验证的更新机制

已验证的更新机制的指导如下：

    • 更新镜像应该由经批准的数字签名算法进行签名
    • 更新镜像应该由经授权的实体进行签名，例如设备制造商、平台制造商或可信的第三方
    • 更新镜像应该在更新到非易失性存储前优先由信任根进行验证

当我们选择数字签名算法时，我们需要考虑政府对算法要求和密钥长度要求。当我们设计解决方案时，我们需要考虑加密灵活性。因此，当要求改变时，它能很容易地迁移到新的算法。实践上，使用PKCS#7是不错的选择，因为它定义了描述密码消息的语法。不同的算法，例如RSA2048/RSA3072或SHA256/SHA384，可以由PKCS#7证书描述。代码不需要显式地选择使用哪种算法。然而，PKCS#7可能包括X.509证书，解析X.509证书很复杂，并且需要大量内存。在资源受限的环境中，例如只有SRAM或有限的DRAM，它可能需要直接使用没有任何封装的算法。

| **注释** | 校验或循环冗余校验在安全世界毫无意义。它们只能用于检测简单的错误，而不是攻击。|
| :--- | :--- |

验证和更新应该在可信执行环境中进行。可信执行环境可能是早期的没有任何第三方代码或不可信代码执行的启动阶段，或它可能是处理器特定的隔离环境，例如英特尔系统管理模式（SMM）或ARM TrustZone，或它可能使用服务器的基板管理控制器（BMC）。我们将在第17章讨论可信执行环境和管理模式的更多细节。

固件更新可能在操作系统环境中进行。例如，Windows和Linux提供了有关怎样使用UEFI定义的胶囊格式在操作系统环境中初始化系统固件更新的指导。

除了系统固件，设备固件可能也需要支持更新。IETF创建了物联网软件更新（SUIT）组为10KB以下RAM和100KB以下闪存的物联网设备提供了指导。TCG嵌入式工作组提供了TCG嵌入式系统软件和固件的安全更新指导。DMTF公布了固件更新平台级别数据模型（PLDM）规范，它定义了平台管理子系统设备上用于更新固件组件的消息和数据结构。


