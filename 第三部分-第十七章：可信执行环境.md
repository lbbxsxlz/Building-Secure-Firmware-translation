## 第十七章

# 可信执行环境

可信执行环境（TEE）是指一个安全区域，它能保证区域内代码和数据的机密性和完整性。TEE通常是一个孤立的执行环境。它可以作为主处理器的一种特殊安全模式来实现，也可以由一个安全协处理器来维护TEE。

## 基于CPU的TEE

首先，让我们看下基于CPU的TEE。

### X86 SMM

早在1990年，Intel 386SL处理器中就引入了系统管理模式（SMM）。正如它的名字一样，SMM是为系统管理而设计的，例如系统事件处理、深度睡眠电源管理、电压调节器管理和特殊唤醒支持。后来，人们发现这种隔离环境对安全功能很有用，例如闪存锁、UEFI安全启动认证变量和TCG MOR2。

<div align=center><img src=Figures/Chapter-17-Screenshot/Figure-17-1.jpg></img></div>
<div align=center>图 17-1 SMM TEE</div>

图17-1显示了SMM TEE。SMM执行环境位于内存的一个特殊部分，称为系统管理RAM (SMRAM)。当CPU收到系统管理中断（SMI）时，会从正常执行模式切换到SMM。正常世界可以触发同步SMI。例如，向I/O端口0xB2写入一个值可触发同步SMI，也称为软件SMI。同样，当进入S1、S3、S4或S5睡眠状态时，向电源控制寄存器写入一个值可触发睡眠控制SMI。硬件可根据系统事件生成异步SMI。例如，可将通用输入(GPI)配置为SMI源。在正常操作系统中，当用户按下电源按钮时，会触发ACPI系统控制中断（SCI），并由操作系统ACPI电源管理子系统处理。然而，在操作系统启动前阶段，ACPI SCI尚未启用。在此阶段，电源按钮事件被配置为SMI事件。当用户在启动固件时按下电源按钮时，该事件将传递给SMM，该事件的处理程序将关闭机器。

<div align=center><img src=Figures/Chapter-17-Screenshot/Figure-17-2.jpg></img></div>
<div align=center>图 17-2 SMM内存布局</div>

图17-2显示了典型的内存布局。每个CPU在SMRAM内都有自己的SMM入口点代码和SMM保存状态。

SMI的一般流程如下所示：
1) 当CPU收到SMI时，会将当前上下文保存到SMM保存状态缓冲区，如RAX、RBX、RCD、RDX、RSP（栈指针）、RIP（指令指针）、CS（代码段）、GDT、IDT等。
2) CPU切换到SMM入口点。
3) 所有CPU会合，只选择一个处理器继续运行。
4) 选中的处理器进入SMM核心。
5) 其余所有应用处理器进入等待循环。
6) SMM内核检查系统状态并确定SMI的来源，例如，SMI是由软件SMI（如I/O端口0xB2写入）触发的，还是由硬件事件（如按下电源按钮）触发的。
7) SMM内核根据SMI的来源调度SMI处理程序，并让相应的SMI处理程序开始执行以完成工作。
8) 当SMI处理程序完成工作后，会清除SMI源指示器并设置结束SMI (EOS)，以解锁下一个SMI。
9) 所有等待的CPU退出等待循环，并通过RSM指令退出SMM环境。
10) CPU从SMM保存状态缓冲区恢复上下文，并继续执行SMI后的下一条可用指令。

由于SMM是一个隔离的执行环境，可以接触到所有系统资源，包括正常世界的丰富执行环境，因此人们通常认为SMM比VMM拥有更高的权限。为了正确实现SMM，我们需要遵循以下SMM安全指南。

