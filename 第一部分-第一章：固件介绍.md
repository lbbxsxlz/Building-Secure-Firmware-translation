## 第一章

# 固件介绍

这一章将提供系统固件的概述。尽管系统固件的实现空间非常广泛，但我们讲论固件安全构造的相关细节。

## 固件与软件的相似之处

固件VS嵌入式系统VS操作系统内核VS操作系统应用

固件是平台软件中最底层的软件。现代固件，比如基于UEFI平台初始化的固件，还有EDK II、U-Boot、coreboot、Open Power的skiboot等等主要是C语言编写并带有小部分的汇编代码。这些代码经常存储在跟平台绑定的非易失性存储容器中。固件与平台软件栈剩余部分的关系如图1-1所示。

![图 1-1 硬件到用户的软件栈](Figures/Figure-1-1.jpg)

鉴于固件是基于C代码，因此也就更容易收到攻击而影响更上层的软件。这些攻击包括内存安全问题，涉及到多种缓存区溢出，例如栈溢出，堆溢出，和整型溢出。此外，针对应用或者操作系统空间的C代码的控制流攻击能对系统固件的做出改动。除了内存问题，针对固件的攻击也可在其他方面发生，包括机密性的问题，例如偷取机密。除此之外，固件常常参与系统的信任根的流程，由于平台的任何非认证的代码流程都能拒绝平台承诺的服务（特性），因此完整性考虑至关重要。平台启动可能包括访问网络，因此网络安全的考虑也能包含在平台固件中。而且，很少有平台（如果有的话）在片上系统（SOC）中只有一个中央处理器（CPU）核心，因此固件必须支持多进程处理（MP），并抵御该应用程序中存在的各种攻击，如竞争条件。最后，平台固件还必须防御其他类型的攻击，如侧通道、混淆代理和检查时间/计时（TOC/TOU）攻击。

鉴于列出的这些弱点，固件可能具有类似的平台强化策略，有针对这些弱点的定制实现。其中包括强化策略，如堆栈cookie检查、数据执行保护（DEP）、地址空间布局随机化（ASLR）、控制流保护/完整性（CFG/CFI）、代码签名强制检查、带解释器的沙箱、访问控制（用户认证和授权）、网络安全以及适用于固件执行环境的密码学。

除了这些防御策略，固件可能有类似软件的安全验证策略，但与上层的软件组织相比有不同的实现。这些验证方法包括静态代码分析、动态代码分析（地址错误检查Address Sanitizer，ASan）、模糊化、符号执行和可能的形式验证。

## 固件与软件的区别

尽管固件通常是用C这样的高级语言编写的，但它通常有特殊的需求。这些需求从环境开始。具体来说，固件的大小限制来源于微控制器中的较小的ROM和较小的RAM，在DRAM准备好之前只有SRAM或cache可用，管理模式(MM)的大小平衡于系统内存和有限的堆栈大小。

其他限制包括早期代码的就地执行（XIP）代码。也就是说，一些代码在ROM中执行。一方面这是些ROM代码，其中的一部分代码在数据段中没有可写的全局变量。并且对于这些早期的代码，例如UEFI平台初始化的PI阶段，Slim Boot的第一阶段，和coreboot的romstage, 尽管可以使用页表，但没有内存管理，包括虚拟内存。

除了内存管理，在早期代码流程中还有执行隔离的挑战。举个例子，Ring分隔（ring level in x86）可能可用也可能不可用。如此，一些固件的实现是仅仅让所有代码在特权模式下运行。尽管硬件可能包含多个CPU核心，但多进程处理（MP）可能启用，也可能不启用。事实上，主机固件的大多数实现是在单个处理器上执行服务。与多进程处理一样，其他常用的能力，如中断可能会被使能，但只能用于比那些操作系统简单得多的用途上。并且不像操作系统，固件通常与硬件直接交互。最后，固件拥有自己的执行基础， 例如内核和引导程序，与像Windows或Linux或管理程序（hypervisor）等高级操作系统（HLOSs）有所区别。

鉴于这些限制，固件可能有一类安全问题需要关注，但却不会出现在高级操作系统中。这些需要关注的安全包括来自硬件的攻击，例如寄存器、设备直接内存访问（DMAs）、缓存等。除了这些威胁，主机固件必须防范ROM中永久拒绝服务（PDoS）攻击，恢复服务通常需要复杂且特殊的恢复机制。并且如果对永久拒绝服务（PDoS）攻击的关注不够，固件可能会受到ROM中的永久根套件的影响，（有问题的套件）很难被病毒扫描工具发现。

## 固件安全介绍

固件是计算机系统安全的基石。针对系统的硬件/固件辅助的攻击越来越多。鉴于固件的领域-特定方面，可能需要特殊的强化策略。总结了三个方向，固件弹性，固件度量和证明，和安全的设备通信， 见图1-2。

![图 1-2 固件安全三个核心](Figures/Figure-1-2.jpg)

### 固件弹性

固件弹性包括图1-3中显示的保护、检测、恢复三个维度。平台固件需要保护自身，检测篡改，并且恢复到已知的良好状态。保护是指固件保持一种完整的状态，并且防止损坏和攻击。检测发生在系统启动阶段来确定固件是否损坏或受到攻击。如果检测到损坏或攻击，信任根固件通过鉴权机制把固件恢复到完整状态。另外，还有固件领域-特定检查，包括硬件寄存器配置检查，例如锁定位的设置，以保持平台固件的时间隔离保证。我们将在第3、4和5章中讨论细节。

![图 1-3 固件弹性能力的三轴](Figures/Figure-1-3.jpg)

### 固件度量与证明

在平台固件使能弹性保护自身之后，固件需要上报其身份并允许远程代理验证其完整性状态，这一过程称之为证明。当原始设备制造商（OEM）或独立
软件供应商（ISV）部署系统时，他们还发布平台属性和系统的黄金度量。系统运行时，系统信任根创建度量日志。因此，远程验证器验证度量，并对其使用黄金度量来验证来了解平台是否处于可信状态，见图1-4。我们将在第7章中讨论细节。

![图 1-4 固件度量与证明](Figures/Figure-1-4.jpg)

### 安全的设备通信

除了弹性和证明，平台固件需要拥有安全的方式与板上的其他固件或硬件组件通信。请求端对响应端认证，并且响应端可能会选择性地要求双向认证。然后，两端就创建了会话进行通信，保证数据的完整性与机密性，从而抵御硬件总线上劫持攻击，见图1-5。我们将在第8章讨论细节。

![图 1-5 安全的设备通信](Figures/Figure-1-5.jpg)

## 主机固件变种介绍

主机固件包括运行在主要的或主机的CPU上的固件，与运行在SOC上的非主机固件与运行在外设上的设备固件不同。主机固件承担平台的多项责任，包括两个主要的角色，初始化硬件和启动下一阶段的系统。前一项的任务是初始化硬件，包括跨越设置中央处理器（CPU）的状态，初始化动态随机存取存储器（DRAM），和枚举I/O总线。主机固件的后一项角色包括访问本地块存储或网络来下载操作系统。这两个阶段都存在各自的威胁模型和硬件依赖。传统的平台包括主机固件和其他设备固件以及非主机固件， 如图1-6所示。

![图 1-6 系统框图](Figures/Figure-1-6.jpg)

## 行业标准

固件的行业标准有好些个。一些标准旨在I/O设备的相互操作性，例如通用串行总线（USB）和外围组件互联（PCI）。这些允许针对硬件接口编程、具有更多一致性的系统软件与具有抽象每个接口能力的唯一设备驱动程序不同。除了这些设备到主机的硬件接口标准外，也存在主机固件与操作系统之间的标准。这些标准包括高级配置与电源接口（ACPI），ACPI详细说明了平台的不可枚举方面以及一组运行时解释表，用于在运行时配置和管理平台状态。另一个重要的标准是系统管理BIOS（SMBIOS）标准，该标准提供了详细说明平台清单的静态表。最后，为了从操作系统加载程序中抽象平台的系统方块、网络和控制台设备，出现了统一可扩展固件接口（UEFI）。 UEFI通过提供众所周知的机制来发现内容完成了类似ACPI，SMBIOS的其他标准，但UEFI更进一步。具体而言，UEFI提供了丰富的能力、接口的集合来发掘在PCI适配卡的可选只读存储器（OPRMs）和存储设备上可执行的内容或“.efi”文件。这允许平台的制造商解耦，例如原始设备制造商（OEM）和操作系统供应商（OSV）。
