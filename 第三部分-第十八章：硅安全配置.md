##  第十八章

# 硅片安全配置

系统固件的作用和责任是初始化硅并启动操作系统。在硅初始化过程中，一项重要任务是将系统寄存器配置为安全状态。在本章中，我们无法涵盖所有可能的硅片安全锁定寄存器。因此，我们将仅讨论一些更重要的寄存器设置作为示例。

## 闪存锁定

系统固件存储在闪存部分。该固件应处于锁定状态，仅被允许的固件执行安全解锁和更新操作。

### BIOS写保护

硅片可能定义一组寄存器来锁定固件。图18-1显示了英特尔平台控制中心（PCH）中的与BIOS锁定相关的寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-1.jpg></img></div>
<div align=center>图 18-1 BIOS控制寄存器（来源：9-series-chipset-pch-datasheet）</div>

BIOS镜像包含代码和数据。有时，我们可能希望更新数据，但不希望更新代码。因此，更新必须在隔离且受保护的环境中进行，例如系统管理模式（SMM）。硅片提供了一种在非SMM环境中锁定BIOS区域的方法，并要求仅在SMM环境中解锁BIOS区域。此操作由SMM BIOS写保护禁用（SMM_BWP）、BIOS写使能（BIOSWE）和BIOS锁定使能（BLE）寄存器位完成。

在正常启动环境中，SMM_BWP为1，BLE为1，BIOSWE为0。由于写使能位未设置，BIOS区域无法被写入。如果非SMM的恶意程序试图将BIOSWE从0改为1，将触发SMI，而SMI处理程序可能清除该BIOSWE位。

若SMM程序需为BIOS提供更新，可采取以下步骤：

1. SMM程序将BIOSWE设置为从0到1。由于系统已处于SMM模式，因此该位可成功设置。
2. SMM 程序开始修改BIOS区域。
3. 一旦SMM程序完成更新，它将清除BIOSWE来再次保护BIOS区域。

由于锁定高度依赖于SMM实现，引入了SMM_BWP，来确保除非所有处理器均处于SMM状态，否则BIOS区域不可写入。

### BIOS区域选择

BIOS区域选择功能用于确定从何处启动。图18-2显示了与BIOS区域选择相关的寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-2(A).jpg></img></div>
<div align=center>图 18-2(A) BIOS区域选择寄存器（来源：9-series-chipset-pch-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-2(B).jpg></img></div>
<div align=center>图 18-2(B) BIOS区域选择寄存器（来源：9-series-chipset-pch-datasheet）</div>

顶部交换（TS）是一项功能，用于将固件中心（Firmware Hub）或串行外设接口（SPI）闪存（也称为引导块）的顶部块与另一个位置进行交换。此功能用于实现引导块的安全更新。当启用此功能时，PCH将对闪存顶部两个块的地址进行反转。例如，如果块大小为64K，则访问FFFF_0000h–FFFF_FFFFh MMIO地址将变为访问FFFE_0000h–FFFE_FFFFh闪存地址，反之亦然。

安全引导块更新可按以下方式使用：
1. 固件将顶部块备份到顶部块下方（交换块）。
2. 固件启用顶部交换功能。这将用于反转的相应地址位发送到FWH或SPI。该位存储在RTC中。
3. 固件擦除顶部块并写入新的顶部块。
4. 固件禁用顶部交换功能。

如果在步骤3中发生任何电源故障重置，系统将从步骤1中备份的引导块启动并执行恢复操作。

Boot BIOS Strap (BBS) 是一项用于选择BIOS从何处区域启动的功能。它可以从LPC总线或SPI总线启动。上一代产品甚至具备从插入式PCI卡启动BIOS，来支持系统恢复的功能，但如今该功能已移除。

TS和BBS均应通过BIOS接口锁定（BILD）寄存器锁定。

### SPI区域锁定

除了BIOS锁定寄存器外，SPI控制器可能还具备额外的锁定功能。图18-3展示了一组受保护区域寄存器，用于控制特定区域的读写访问。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-3(A).jpg></img></div>
<div align=center>图 18-3(A) SPI区域寄存器（来源：9-series-chipset-pch-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-3(B).jpg></img></div>
<div align=center>图 18-3(B) SPI区域寄存器（来源：9-series-chipset-pch-datasheet）</div>

PCH SPI控制器提供了一组受保护范围（PR）寄存器。PR寄存器的优势在于将闪存保护与系统管理模式（SMM）环境解耦。在启动过程中，固件可将代码区域设置为由PR寄存器保护，并通过闪存配置锁定（FLOCKDN）功能对其进行锁定。因此，即使SMM环境遭到破坏，BIOS代码区域仍是被保护的。

### SPI区域访问控制

SPI区域可能被分配给不同的主控，例如BIOS或管理引擎（ME）。因此，我们可能需要细粒度访问控制，以防止BIOS主控访问ME区域，同时也不允许ME主控访问BIOS区域。图18-4显示了PCH中提供的闪存区域访问权限（FRAP）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-4.jpg></img></div>
<div align=center>图 18-4 SPI闪存区域访问权限寄存器（来源：9-series-chipset-pch-datasheet）</div>

### SMM锁

系统管理模式（SMM）锁与闪存锁同样重要，因为SMM环境的执行权限高于操作系统内核，甚至高于管理程序。

#### SMRAM访问锁

系统管理随机存取存储器（SMRAM）由存储控制器控制。图18-5显示了英特尔存储控制器中心（MCH）中的SMRAM控制（SMRAMC）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-5.jpg></img></div>
<div align=center>图 18-5 SMRAM控制寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

当D_OPEN位被设置时，SMRAM对正常执行模式可见。在此状态下，BIOS可初始化SMRAM中的内容。一旦BIOS完成SMRAM内容更新，BIOS应设置D_CLS位来关闭SMRAM区域，并设置D_LCK位来锁定配置，从而防止恶意代码篡改SMRAM中的内容。

#### SMRAM位置锁

系统管理RAM（SMRAM）的位置同样由存储控制器定义。图18-6展示了英特尔存储控制器中心（MCH）中的TSEG内存基址（TSEGMB）寄存器与图形翻译表（GTT）窃取内存基址（BGSM）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-6(A).jpg></img></div>
<div align=center>图 18-6(A) TESG内存基址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-6(B).jpg></img></div>
<div align=center>图 18-6(B) 图形翻译表窃取内存基址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

TSEGMB与BGSM之间的存储为SMRAM。因此，BIOS应在启动过程中锁定TSEGMB和BGSM。

### SMRAM地址别名锁

在第16章中，我们讨论了利用硬件重映射机制对SMM实施地址别名攻击的方法。

缓解措施是BIOS应始终锁定系统内存布局寄存器。图18-7展示了英特尔存储控制器中心（MCH）定义的一组内存布局寄存器，包括重映射基址（REMAPBASE）、重映射限制地址（REMAPLMIT）、内存顶端（TOM）、高可用DRAM顶部（TOUUD）及低可用DRAM顶部（TOLUD）。内存布局的详细信息已在第16章图16-1中展示。 【注原文是图16-4】

BIOS应在启动过程中锁定所有内存布局配置寄存器。否则攻击者可通过修改内存映射布局引发地址别名漏洞，导致内存重叠。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-7(A).jpg></img></div>
<div align=center>图 18-7(A) 重映射基址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-7(B).jpg></img></div>
<div align=center>图 18-7(B) 重映射限制地址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-7(C).jpg></img></div>
<div align=center>图 18-7(C) 内存顶端寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-7(D).jpg></img></div>
<div align=center>图 18-7(D) 高可用DRAM顶部寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-7(E).jpg></img></div>
<div align=center>图 18-7(E) 低可用DRAM顶部寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

### SMRR

我们在第17章讨论过，英特尔CPU引入了SMRAM范围寄存器（SMRR）来抵御缓存中毒攻击。图18-8展示了《英特尔64与IA-32架构软件开发人员手册》中的SMRR。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-8.jpg></img></div>
<div align=center>图 18-8 SMRR（来源：Intel 64 and IA-32 Architecture Software Developer Manuals）</div>

SMRR物理基址与物理掩码对定义了SMM内SMRAM区域的可缓存性。当系统运行于非SMM代码时，SMRAM始终被视为不可缓存。BIOS应始终初始化SMRR以保护SMRAM免受缓存攻击。需特别注意SMRR设置应与内存控制器集线器中的SMRAM设置完全一致。

### SMM代码访问检查

由于SMM具有如此高的权限，一种可能的SMM攻击是让SMM代码执行非SMM代码。这类似于返回用户模式攻击。英特尔CPU引入了SMM代码访问检查，当SMM代码调用SMRAM外部资源时会触发机器检查异常（MCE）。该解决方案采用与监督模式执行预防（SMEP）相似的原理。详见图18-9。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-9.jpg></img></div>
<div align=center>图 18-9 SMM代码访问检查（来源：Intel 64 and IA-32 Architecture Software Developer Manuals）</div>

### 全局SMI锁

某些BIOS保护机制，例如如闪存保护，依赖于系统管理模式（SMM）。若攻击者试图执行解锁操作，将触发SMI。SMI处理程序可重新锁定配置。然而，PCH寄存器中可启用或禁用SMI功能。若攻击者禁用SMI，则基于SMM的保护机制将被绕过。

图18-10展示了英特尔平台控制器中心（PCH）中的SMI启用寄存器与SMI锁定寄存器。SMI_EN寄存器中的全局SMI启用位（GBL_SMI_EN）表明是否可基于已启用事件生成SMI。该位可被通用PM配置寄存器（GEN_PMCON）中的SMI锁定位（SMI_LOCK）锁定。BIOS应设置PCH中的SMI_LOCK来锁定GBL_SMI_EN位，从而防范此类SMI禁用攻击。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-10(A).jpg></img></div>
<div align=center>图 18-10(A) 全局SMI启用寄存器（来源：9-series-chipset-pch-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-10(B).jpg></img></div>
<div align=center>图 18-10(B) SMI锁定寄存器（来源：9-series-chipset-pch-datasheet）</div>

## IOMMU

我们在第8章讨论了设备安全问题。来自设备的威胁之一是直接内存访问（DMA）攻击。为缓解此类威胁，固件应配置输入/输出内存管理单元（IOMMU），以阻止外部设备发起的DMA攻击，甚至阻止内部设备发起的攻击——若该内部设备同样被视为不可信。作为实现选择，固件可设置DMA转换表以实现精细控制，或配置一组DMA保护内存区域用于粗粒度控制。

### DRAM的IOMMU保护

设置IOMMU的时机至关重要。通常，外部外设组件互连（PCI）设备会在PCI配置空间中设置总线主控使能（BME）控制，并且BME位默认是禁用的。然而某些内部设备始终可作为总线主控运行。既无法禁用总线主控，其BME位也默认处于启用状态。此外，恶意PCI设备，例如攻击性FPGA，可能声称支持BME，实则无视该控制。因此，BIOS应在内存控制器初始化动态随机存取存储器（DRAM）之前配置IOMMU以保护动态DRAM，从而防范来自内部设备的DMA攻击。

### SRAM的IOMMU保护

内部设备也可对静态RAM（SRAM）执行DMA。例如，微型IA系统代理（MISA）的IOMMU机制为外部DMA代理提供了访问英特尔融合安全与管理引擎（CSME）中SRAM的功能。硬件应默认启用IOMMU机制，以防止对SRAM的DMA攻击。随后，固件可根据请求向特定设备授予DMA访问权限。

### 用于DMA防护的硅支持

不同硬件可能支持不同的方式启用/禁用DMA功能。例如，标准PCI设备在命令寄存器中包含总线主控启用位（BME）。若主机软件为特定PCI设备启用BME，则该设备便具备向主机内存发起DMA的能力。

主机系统可能采用多种方式配置支持DMA的内存或不支持DMA的内存。我们在第8章讨论过某些技术，例如I/O内存管理单元（IOMMU）转换表、英特尔VT-d受保护内存区域（PMR）、英特尔DMA受保护区域（DPA）以及英特尔通用受保护内存范围（GENPROTRANGE）。

英特尔Quark X1000 SoC包含一组称为隔离内存区域（IMR）的范围寄存器。IMR可用于特定系统代理对内存进行非预期访问保护。例如，某些I/O外围设备可能试图写入包含执行代码的内存区域，而该区域仅应允许主机内核访问，例如DMA访问。系统中存在三类IMR：系统DRAM的通用IMR、系统MMIO的主内存I/O边界IMR，以及SMRAM的SMM IMR。未锁定的IMR设置为临时状态，锁定后则成为永久设置。这类似于ARM内存保护单元（MPU）和SPI闪存区域访问权限（FRAP）寄存器。图18-11展示了IMR区域及访问控制寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-11(A).jpg></img></div>
<div align=center>图 18-11(A) IMR低地址寄存器（来源：Quark X1000 Datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-11(A).jpg></img></div>
<div align=center>图 18-11(B) IMR高地址寄存器（来源：Quark X1000 Datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-11(A).jpg></img></div>
<div align=center>图 18-11(C) IMR读掩码寄存器（来源：Quark X1000 Datasheet）</div>

## 总结

在本章中，我们讨论了若干硅安全配置机制，包括闪存锁定、SMM锁定以及IOMMU启用。在下一章中，我们将探讨固件中使用的密码学技术。

## 参考

**会议、期刊与论文**

[P-1] Bing Sun, “BIOS Boot Hijacking,” in Power of Community 2007, available at https://powerofcommunity.net/assets/v0/poc2007/sunbing.pdf 【注1】

[P-2] Rafal Wojtczuk, Joanna Rutkowska, Alexander Tereshkin, “Another Way to Circumvent Intel® Trusted Execution Technology,” in invisiblethingslab whitepaper 2009, available at https://invisiblethingslab.com/resources/misc09/Another%20TXT%20Attack.pdf

[P-3] Joanna Rutkowska, Rafal Wojtczuk, “Preventing and Detecting Xen Hypervisor Subversions,” in BlackHat US 2008, available at https://invisiblethingslab.com/resources/bh08/part2-full.pdf

[P-4] Shai Hasarfaty, Yanai Moyal, “Behind the Scenes of Intel Security and Manageability Engine,” in Blackhat US 2019, https://i.blackhat.com/USA-19/Wednesday/us-19-Hasarfaty-Behind-The-Scenes-Of-Intel-Security-And-Manageability-Engine.pdf

[P-5] Mark Ermolov, “Intel x86 Root of Trust: loss of trust,” in 2020, https://malware.news/t/intel-x86-root-of-trust-loss-of-trust/37808 【注1】

[P-6] Cuauhtemoc Chavez-Corona, Jorge Gonzalez-Diaz, Rene Henriquez-Garcia, Laura Fuentes-Castaneda, Jan Seidl, “Abusing CPU Hot-Add weaknesses to escalate privileges in Server Datacenters,” in CanSecWest 2017, available at https://www.slideshare.net/slideshow/privilege-escalation-on-highend-servers-due-to-implementation-gaps-in-cpu-hotadd-flow/73217903 【注1】

[P-7] Intel, “The Intel Converged Security and Management Engine IOMMU Hardware Issue – CVE-2019-0090,” 2020, https://www.intel.com/content/dam/www/public/us/en/security-advisory/documents/cve-2019-0090-whitepaper.pdf

**规范和指南**

[S-1] Intel, “Intel 64 and IA-32 Architecture Software Developer Manuals,” 2019, available at https://software.intel.com/en-us/articles/intel-sdm

[S-2] Intel, “6th Generation Intel® Processor Datasheet for S-Platforms,” 2016, https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/desktop-6th-gen-core-family-datasheet-vol-1.pdf, https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/desktop-6th-gen-core-family-datasheet-vol-2.pdf

[S-3] Intel, “Intel 9 Series Chipset Family Platform Controller Hub,” 2015, https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf

[S-4] Intel, “Intel® Quark SoC X1000 Data Sheet,” 2015, 
https://www.intel.com/content/dam/support/us/en/documents/processors/quark/sb/quarkdatasheetrev02.pdf 【注1】

[S-5] Intel, “Intel® Quark SoC X1000 Secure Boot – Programmer’s Reference Manual (PRM),” 2014, https://cdrdv2.intel.com/v1/dl/getContent/840756?fileName=quark_securebootprm_330234_001.pdf 【注1】

[S-6] Microsoft, “Hardware Security Testability Specification,” 2018, https://docs.microsoft.com/en-us/windows-hardware/test/hlk/testref/hardware-security-testability-specification

【注1】原链接失效，已替换新链接