##  第十八章

# 硅片安全配置

系统固件的作用和责任是初始化硅并启动操作系统。在硅初始化过程中，一项重要任务是将系统寄存器配置为安全状态。在本章中，我们无法涵盖所有可能的硅片安全锁定寄存器。因此，我们将仅讨论一些更重要的寄存器设置作为示例。

## 闪存锁定

系统固件存储在闪存部分。该固件应处于锁定状态，仅被允许的固件执行安全解锁和更新操作。

### BIOS写保护

硅片可能定义一组寄存器来锁定固件。图18-1显示了英特尔平台控制中心（PCH）中的与BIOS锁定相关的寄存器。

<div align=center><img src=Figures/Chapter-17-Screenshot/Figure-18-1.jpg></img></div>
<div align=center>图 18-1 BIOS控制寄存器（来源：9-series-chipset-pch-datasheet）</div>

BIOS镜像包含代码和数据。有时，我们可能希望更新数据，但不希望更新代码。因此，更新必须在隔离且受保护的环境中进行，例如系统管理模式（SMM）。硅片提供了一种在非SMM环境中锁定BIOS区域的方法，并要求仅在SMM环境中解锁BIOS区域。此操作由SMM BIOS写保护禁用（SMM_BWP）、BIOS写使能（BIOSWE）和BIOS锁定使能（BLE）寄存器位完成。

在正常启动环境中，SMM_BWP为1，BLE为1，BIOSWE为0。由于写使能位未设置，BIOS区域无法被写入。如果非SMM的恶意程序试图将BIOSWE从0改为1，将触发SMI，而SMI处理程序可能清除该BIOSWE位。

若SMM程序需为BIOS提供更新，可采取以下步骤：

1. SMM程序将BIOSWE设置为从0到1。由于系统已处于SMM模式，因此该位可成功设置。
2. SMM 程序开始修改BIOS区域。
3. 一旦SMM程序完成更新，它将清除BIOSWE来再次保护BIOS区域。

由于锁定高度依赖于SMM实现，引入了SMM_BWP，来确保除非所有处理器均处于SMM状态，否则BIOS区域不可写入。

