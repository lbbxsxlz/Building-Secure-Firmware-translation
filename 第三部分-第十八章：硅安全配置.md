##  第十八章

# 硅片安全配置

系统固件的作用和责任是初始化硅并启动操作系统。在硅初始化过程中，一项重要任务是将系统寄存器配置为安全状态。在本章中，我们无法涵盖所有可能的硅片安全锁定寄存器。因此，我们将仅讨论一些更重要的寄存器设置作为示例。

## 闪存锁定

系统固件存储在闪存部分。该固件应处于锁定状态，仅被允许的固件执行安全解锁和更新操作。

### BIOS写保护

硅片可能定义一组寄存器来锁定固件。图18-1显示了英特尔平台控制中心（PCH）中的与BIOS锁定相关的寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-1.jpg></img></div>
<div align=center>图 18-1 BIOS控制寄存器（来源：9-series-chipset-pch-datasheet）</div>

BIOS镜像包含代码和数据。有时，我们可能希望更新数据，但不希望更新代码。因此，更新必须在隔离且受保护的环境中进行，例如系统管理模式（SMM）。硅片提供了一种在非SMM环境中锁定BIOS区域的方法，并要求仅在SMM环境中解锁BIOS区域。此操作由SMM BIOS写保护禁用（SMM_BWP）、BIOS写使能（BIOSWE）和BIOS锁定使能（BLE）寄存器位完成。

在正常启动环境中，SMM_BWP为1，BLE为1，BIOSWE为0。由于写使能位未设置，BIOS区域无法被写入。如果非SMM的恶意程序试图将BIOSWE从0改为1，将触发SMI，而SMI处理程序可能清除该BIOSWE位。

若SMM程序需为BIOS提供更新，可采取以下步骤：

1. SMM程序将BIOSWE设置为从0到1。由于系统已处于SMM模式，因此该位可成功设置。
2. SMM 程序开始修改BIOS区域。
3. 一旦SMM程序完成更新，它将清除BIOSWE来再次保护BIOS区域。

由于锁定高度依赖于SMM实现，引入了SMM_BWP，来确保除非所有处理器均处于SMM状态，否则BIOS区域不可写入。

### BIOS区域选择

BIOS区域选择功能用于确定从何处启动。图18-2显示了与BIOS区域选择相关的寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-2(A).jpg></img></div>
<div align=center>图 18-2(A) BIOS区域选择寄存器（来源：9-series-chipset-pch-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-2(B).jpg></img></div>
<div align=center>图 18-2(B) BIOS区域选择寄存器（来源：9-series-chipset-pch-datasheet）</div>

顶部交换（TS）是一项功能，用于将固件中心（Firmware Hub）或串行外设接口（SPI）闪存（也称为引导块）的顶部块与另一个位置进行交换。此功能用于实现引导块的安全更新。当启用此功能时，PCH将对闪存顶部两个块的地址进行反转。例如，如果块大小为64K，则访问FFFF_0000h–FFFF_FFFFh MMIO地址将变为访问FFFE_0000h–FFFE_FFFFh闪存地址，反之亦然。

安全引导块更新可按以下方式使用：
1. 固件将顶部块备份到顶部块下方（交换块）。
2. 固件启用顶部交换功能。这将用于反转的相应地址位发送到FWH或SPI。该位存储在RTC中。
3. 固件擦除顶部块并写入新的顶部块。
4. 固件禁用顶部交换功能。

如果在步骤3中发生任何电源故障重置，系统将从步骤1中备份的引导块启动并执行恢复操作。

Boot BIOS Strap (BBS) 是一项用于选择BIOS从何处区域启动的功能。它可以从LPC总线或SPI总线启动。上一代产品甚至具备从插入式PCI卡启动BIOS，来支持系统恢复的功能，但如今该功能已移除。

TS和BBS均应通过BIOS接口锁定（BILD）寄存器锁定。

### SPI区域锁定

除了BIOS锁定寄存器外，SPI控制器可能还具备额外的锁定功能。图18-3展示了一组受保护区域寄存器，用于控制特定区域的读写访问。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-3(A).jpg></img></div>
<div align=center>图 18-3(A) SPI区域寄存器（来源：9-series-chipset-pch-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-3(B).jpg></img></div>
<div align=center>图 18-3(B) SPI区域寄存器（来源：9-series-chipset-pch-datasheet）</div>

PCH SPI控制器提供了一组受保护范围（PR）寄存器。PR寄存器的优势在于将闪存保护与系统管理模式（SMM）环境解耦。在启动过程中，固件可将代码区域设置为由PR寄存器保护，并通过闪存配置锁定（FLOCKDN）功能对其进行锁定。因此，即使SMM环境遭到破坏，BIOS代码区域仍是被保护的。

### SPI区域访问控制

SPI区域可能被分配给不同的主控，例如BIOS或管理引擎（ME）。因此，我们可能需要细粒度访问控制，以防止BIOS主控访问ME区域，同时也不允许ME主控访问BIOS区域。图18-4显示了PCH中提供的闪存区域访问权限（FRAP）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-4.jpg></img></div>
<div align=center>图 18-4 SPI闪存区域访问权限寄存器（来源：9-series-chipset-pch-datasheet）</div>

### SMM锁

系统管理模式（SMM）锁与闪存锁同样重要，因为SMM环境的执行权限高于操作系统内核，甚至高于管理程序。

#### SMRAM访问锁

系统管理随机存取存储器（SMRAM）由存储控制器控制。图18-5显示了英特尔存储控制器中心（MCH）中的SMRAM控制（SMRAMC）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-5.jpg></img></div>
<div align=center>图 18-5 SMRAM控制寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

当D_OPEN位被设置时，SMRAM对正常执行模式可见。在此状态下，BIOS可初始化SMRAM中的内容。一旦BIOS完成SMRAM内容更新，BIOS应设置D_CLS位来关闭SMRAM区域，并设置D_LCK位来锁定配置，从而防止恶意代码篡改SMRAM中的内容。

#### SMRAM位置锁

系统管理RAM（SMRAM）的位置同样由存储控制器定义。图18-6展示了英特尔存储控制器中心（MCH）中的TSEG内存基址（TSEGMB）寄存器与图形翻译表（GTT）窃取内存基址（BGSM）寄存器。

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-6(A).jpg></img></div>
<div align=center>图 18-6(A) TESG内存基址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

<div align=center><img src=Figures/Chapter-18-Screenshot/Figure-18-6(B).jpg></img></div>
<div align=center>图 18-6(B) 图形翻译表窃取内存基址寄存器（来源：desktop-6th-gen-core-family-datasheet）</div>

TSEGMB与BGSM之间的存储为SMRAM。因此，BIOS应在启动过程中锁定TSEGMB和BGSM。
