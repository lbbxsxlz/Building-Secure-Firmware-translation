## 第十九章

# 密码学

当实现固件并添加安全功能时，例如固件镜像验证和固件证明，我们需要运用密码学来保护系统。经典密码学可追溯至罗马帝国时期人们使用的凯撒密码，其发展历程终结于第二次世界大战 —— 当时德国人使用恩尼格玛密码机加密信息，而英国密码学家最终通过“炸弹”（一种机电设备）破译了该密码机。经典密码的两种类型是替换密码和置换密码。然而，大多数经典密码均可通过手工计算破解，更可被现代计算机与通信技术攻破。20世纪70年代，人类正式迈入现代密码学时代。

1972年，美国国家标准局（NBS）征集可用于消息加密的标准化密码提案。最终，NBS于1977年发布了数据加密标准（DES）。这标志着重大变革，因为这是首次实现密码学算法的标准化。如今，NBS已更名为美国国家标准与技术研究院（NIST）。DES已不再安全，已被高级加密标准（AES）取代。众多密码学著作介绍了这些标准化加密算法及其背后的数学原理。本章将不深入探讨加密算法细节，而是聚焦于如何运用这些标准化加密算法来强化系统安全性。

## 现代密码学

现代密码学包含两大领域：对称算法和非对称算法。对称算法自经典密码学时代便已存在。在对称算法中，发送方和接收方使用相同的密钥加密和解密数据。见图19-1。

<div align=center><img src=Figures/Chapter-19-Screenshot/Figure-19-1.jpg></img></div>
<div align=center>图 19-1 对称密码学</div>

长期以来，这被视为加密与解密的唯一方法。转折点出现在1976年，Whitfield Diffie与Martin Hellman发表《密码学的新方向》，提出了公钥密码学，也称为非对称密码学。借助非对称密码学，我们不仅能实现数据加密，还能实现数字签名和密钥建立等更多功能。见图19-2、图19-3和图19-4。

<div align=center><img src=Figures/Chapter-19-Screenshot/Figure-19-2.jpg></img></div>
<div align=center>图 19-2 非对称密码学 —— 数据加密</div>

<div align=center><img src=Figures/Chapter-19-Screenshot/Figure-19-3.jpg></img></div>
<div align=center>图 19-3 非对称密码学 —— 数字签名</div>

<div align=center><img src=Figures/Chapter-19-Screenshot/Figure-19-1.jpg></img></div>
<div align=center>图 19-4 非对称密码学 —— 密钥建立</div>

### 固件中的密码学应用

固件可能同时包含对称算法和非对称算法。表19-1展示了固件中加密算法的使用情况。从该表可见，最常见的应用是数字签名验证，包括哈希算法。数字签名是验证固件镜像或数据完整性与真实性的手段。在第3、4、5章中，我们已探讨过安全启动、固件更新以及固件恢复。这些功能均需要签名验证。虽然镜像加密并非完整性考虑的强制要求，但作为机密性考虑的有效手段，它能保护知识产权（IP）并提升攻击门槛。在第七章，我们探讨了可信启动功能。该功能虽不验证数字签名，但扩展了镜像或数据的哈希值，作为防篡改空间的测量值，例如可信平台模块（TPM），以便后续进行本地或远程证明。

在第8章中，我们探讨了主机与设备固件通过安全协议与数据模型（SPDM）进行交互。SPDM 1.0的测量与认证需要哈希函数和数字签名验证。SPDM 1.1新增了基于消息认证码（MAC）的密钥交换能力以建立会话。随后双方可使用分组密码来加密通信数据。

在第10章中，我们探讨了用户认证功能与硬盘驱动器（HDD）密码功能。为支持密码验证，需将哈希值与盐值数据保存至UEFI变量。第11章，我们用UEFI变量为例，探讨了配置保护。UEFI认证变量更新需要签名验证以维护变量区域完整性。UEFI变量还可采用分组密码加密数据，并使用消息认证码（MAC）防止回滚攻击。

最后，固件可能包含网络栈。iSCSI启动机制在质疑-握手认证协议（CHAP）中采用哈希算法。HTTPs启动则需要传输层安全（TLS）支持。TLS握手包括数字签名验证、密钥交换和消息认证码（MAC）。一旦会话密钥生成后，TLS驱动程序使用分组密码或流密码加密通信。

表 19-1 固件中的密码学应用

|    功能    |  对称算法  |        |        |        |  非对称算法  |        |        |
| :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- |
|        |  分组密码  |   流密码   |    哈希     | 消息认证码 |  数字签名  | 数字签名验证 |  密钥交换  |
| 安全启动（镜像验证）|    |     | V |          |         |   V   |        |
| 固件更新 |        |        |   V   |        |        |   V   |        |
| 固件恢复 |        |        |   V   |        |        |   V   |        |
| 镜像加密 |   V   |        |        |        |        |        |        |
| 可信启动（测量）|        |        |   V   |        |        |        |        |
|  SPDM  |   V   |        |   V   |   V   |  (V)  |        |   V   |
| 用户认证 |        |        |   V   |        |        |        |        |
| HDD密码 |        |        |   V   |        |        |        |        |
| 认证变量更新 |        |        |   V   |        |        |   V   |        |
| 变量加密和回滚预防 |   V   |        |        |   V   |        |        |        |
| iSCSI启动 |        |        |   V   |        |        |        |        |
| HTTPs |   V   |        |   V   |   V   |  (V)  |   V   |   V   |

### 算法推荐

加密算法可来源于不同渠道，包括互联网工程任务组（IETF）、国际标准化组织（ISO）以及美国国家标准与技术研究院（NIST）的联邦信息处理标准（FIPS）。NIST还发布SP800系列文档，为加密算法的使用提供建议或指导。国家安全局（NSA）发布了商用国家安全算法（CNSA）套件用于推荐算法保护绝密信息。见表19-2。

表 19-2 密码学的算法推荐

|   功能   |        |   算法   | NIST推荐（NIST SP800-131A）| NSA推荐（NSACNSA）|
| :----- | :----- | :----- | :----- | :----- |
| 对称算法 | 分组密码 | AES | AES-128 | AES-256 |
|        |   哈希   | SHA256 | SHA384 |
| 非对称算法 | 数字签名 | RSA | RSA-2048 | RSA-3072 |
|        |        | ECDSA | P-256 | P-384 |
|        | 密钥建立 | RSA | RSA-2048 | RSA-3072 |
|        |        | DH | DH 2048bit | DH 3072bit |
|        |        | EC_DH | P-256 | P-384 |

