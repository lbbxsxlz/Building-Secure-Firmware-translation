## 第五章

# 固件弹性：恢复

本章描述平台弹性的一个重要方面 —— 恢复。这支持CIA三要素（保密性、完整性和可用性）中的可用性方面。如果平台检测到组件（包括代码或数据）的完整性被破坏，平台需要将组件恢复到已知的良好状态。这一过程称为恢复。它是固件弹性的最后一个要素。恢复过程是更新过程的一个变体。它将系统更新到旧状态。因此，在恢复过程中应遵循更新的所有指导，如签名检查和版本检查。

## 镜像恢复

恢复过程由恢复信任根（RTRec）或恢复信任链（CTRec）执行。RTRec和CTRec应为不可变代码或已知的良好代码。如果RTRec或CTRec无法建立，则最终用户必须执行手动恢复。例如，如果整个闪存芯片损坏或擦除，甚至获取的第一条CPU指令都是无效操作码。在这种情况下，最终用户可能需要在闪存芯片上接入闪存编程器并烧录新的镜像，或者将机器运回制造商处维修。

### 恢复信任根选择和恢复策略

RTRec和CTRec可能与检测信任根(RTD)和检测信任链(CTD)相同，也可能不同。根据RTRec和RTD之间的关系，平台可能使用不同的方式进行恢复（见表5-1）。

表 5-1 恢复策略
| **机制** | **RTRec/RTD关系** | **细节** | **实例** |
| :--- | :--- | :--- | :--- |
| 立即恢复 | RTRec与RTD是一样的。 | 一旦RTD检测到未经授权的更改，RTD就会调用RTRec，RTRec会立即开始进行恢复。| EDK II签名恢复。Coreboot恢复。HP Sure Start。Cerberus项目。英特尔PFR冷重启。|
| 重置恢复 | RTRec在RTD/CTD之前运行。 | 一旦RTD/CTD检测到未经授权的更改，RTD/CTD就将平台状态设置为"恢复模式"并重置系统。在下次启动时，RTRec检测“恢复模式”并执行恢复。| 英特尔PFR热重启。|
| 降级启动和延迟恢复 | RTRec在RTD/CTD之后运行。| 一旦RTD/CTD检测到未经授权的更改，RTD/CTD将继续启动系统，并携带验证失败时的可检测指示符，例如TPM测量值。平台RTRec可能有机会在后续将系统恢复到正常状态。| 带有执行策略设置为超时关机的英特尔Boot Guard。|
| 停止和带外恢复 | RTD与RTRec在不同领域。| 一旦RTD/CTD检测到未经授权的更改，RTD/CTD就会立即停止系统，而不具备任何带内恢复能力。因此，只有带外（OOB）RTRec才能恢复系统。| 带有执行策略设置为立即关机的英特尔Boot Guard。|

### 恢复镜像选择

恢复映像可能是系统上不可改变ROM、系统上制造商提供的上一个已知的良好的镜像、或最终用户保存的镜像。如果恢复镜像是可变的，则恢复镜像更新必须遵循与正常镜像更新相同的流程，例如镜像保护、签名检查、版本检查等等（见表5-2）。

表 5-2 恢复镜像选择
| **机制** | **优点** | **缺点** |
| :--- | :--- | :--- |
| 不可改变的ROM | 无法破解不可改变ROM。| 如果不可改变的ROM有漏洞，漏洞是永久的。|
| 上一个已知良好的镜像 | 平台自动更新恢复镜像，并且平台保证恢复镜像中不存在已知安全漏洞。| 很难去定义什么是“良好”。或许平台保存的镜像存在很多功能上的问题。|
| 最终用户保存的镜像 | 最终用户有自由决定使用哪个镜像进行恢复。| 需要与最终用户交流。最终用户可能选择有漏洞的镜像。|

自动保存上一个已知良好映像的解决方案是一个挑战，因为"良好"的定义无法精确界定。当固件成功传输到操作系统加载器时，我们能说新镜像是"良好"吗？或者当操作系统成功启动时？或者当操作系统设备驱动程序全部启动时？或者当操作系统中业务应用程序开始运行时？或者操作系统通过证书测试时？没有统一的答案，平台设计者需要做出抉择来平衡所需的操作系统功能，证明系统处于良好状态。

### 恢复镜像位置

恢复映像可能在系统ROM中，例如闪存设备；不可拆卸磁盘上，例如硬驱；或者可移除磁盘，例如USB密钥或CDROM/DVDROM；或通过传输从远程位置传递，例如串口或网络；甚至来自带外管理设备（见表5-3）。

表 5-3 恢复镜像位置

| **机制** | **优点** | **缺点** | **实例** |
| :--- | :--- | :--- | :--- |
| 闪存ROM | 恢复镜像一直存在。| 成本较高。| 在相同的闪存设备或不同的闪存设备上。|
| 不可移除磁盘 | 不增加的成本。| 恢复镜像本身需要受到保护，并且只允许经过授权的恢复镜像更新。| 硬驱（硬盘驱动（HDD）、固态硬盘（SSD）、NVMe等等） —— 隐藏分区或系统分区。|
| 可移除磁盘 | 恢复镜像无法被攻击，因为它在正常启动时没有连接到系统。| 需要与用户交流。最终用户保证恢复镜像的正确性。| CDROM/DvDROM，USB密钥。|
| 远程传输 | 无需接触本地机器。| 网络驱动栈必须在RTRec中。必须设置恢复服务器。| 网络（以太网、Wi-Fi、蓝牙等等），串口。|
| 带外传输 | 便于远程管理。| 带外引擎需要访问闪存。| 基板管理控制器（BMC），可管理引擎。|

### 案例研究

现在，让我们看一下镜像恢复的一些实例。

### PCH：顶部交换（TS）

在正常启动过程中，芯片会将闪存芯片的两个64KB的顶部启动块映射到地址[0xE0000, 0xFFFFF)。当CPU从复位向量 —— 0xF000:0xFFF0 ——启动时，CPU可以直接在闪存上执行指令。由于典型的16位真实模式引导块代码会立即切换到32位保护模式以访问整个闪存区域（可能大于1MB），因此这些相同引导块也会映射到[0xFFFE0000，0xFFFFFFFF]。见图 5-1。

<div align=center><img src=Figures/Chapter-5-Screenshot/Figure-5-1.jpg></img></div>
<div align=center>图 5-1 英特尔Boot Guard镜像TOC/TOU攻击</div>