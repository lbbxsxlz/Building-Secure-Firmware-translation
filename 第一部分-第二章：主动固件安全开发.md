## 第二章

[TOC]

# 主动固件安全开发

固件开发与软件开发相似。几乎所有的软件安全开发生命周期（SDL）实践都可以应用于固件开发。图2-1显示了固件开发中可能涉及的主要活动。

![图 2-1 软件安全开发生命周期中的安全活动](Figures/Figure-2-1.jpg)

## 需求阶段

第一步是收集安全需求。没有明确的要求，就不知道在什么情况下该保护什么。

### 安全需求

任何产品都有需求。可以将需求视作‘任何渴望或需要的声明’。这包括功能性需求，例如产品应该执行哪些行为。也存在市场需求，例如产品应该何时上市以及花费多少成本。最后，存在安全需求，包括产品必须遵守的安全属性，包括各种威胁的缓解措施。

安全需求也应该包括行业标准要求。如果在美国生产，则需要遵循NIST指南，如NIST SP800-193《平台固件弹性指南》。如果在中国生产，则需要遵循GB(强制)或GB/T（推荐）规范，例如GB/T 36639-可信计算规范：针对服务器的可信的支持平台。如果是X86个人计算机或服务器平台，则可能需要遵循通用可扩展固件接口（UEFI）规范和TCG标准，如PC客户端平台固件概述（PFP）规范或设备标识组合引擎（DICE）架构。如果是ARM产品，则可能需要遵循ARM平台安全架构（PSA）规范或ARMv8M的可信基础系统架构（TBSA）。对于车辆产品，可能需要遵守ISO 26262功能安全要求。

## 威胁模型与架构阶段

威胁模型和安全体系结构来源于安全需求。他们将客户的语言映射为开发人员的语言。

### 威胁模型分析

就威胁而言，威胁模型分析是从假设攻击者的角度识别潜在威胁并对其进行优先处理的过程。威胁模型分析应该在功能架构阶段进行。功能架构师应与安全架构师合作，识别资产、对手和威胁（攻击面），然后确定威胁的优先级，并选择缓解措施。在（进行）这些步骤之前，架构师需要清楚地了解系统是怎么工作的。

现有的书籍和工具可以教授如何执行威胁模型分析。这些现有材料大多从控制流分析（CFA）和数据流分析（DFA）开始。控制流分析（CFA）关注代码如何从一个地方运行到另一个地方。另一方面，数据流分析（DFA）侧重于如何将数据从一个地方移动到另一个地方。

最后，我们需要优先处理这些威胁。应该同时考虑威胁被利用的可能性和对系统的影响。可以选择处理严重的、高优先级的威胁并定义缓解措施。可以选择不处理中等或低优先级的威胁，并留到下一代产品。举个例子，来自恶意硬件的的威胁之前没有考虑过，现在则需要考虑它，因为硬件攻击越来越频繁。一些新的攻击，例如故障攻击，对于低成本的商业平台被认为是中等优先级，但是对于高品质的平台而言就是高优先级。

为了了解更多细节，以STRIDE威胁模型作为例子。这里讨论的威胁模型是一个通用的指南，是系统固件的基线。对于每个特定的功能，除了通用的威胁模型，还会有额外的基于功能的威胁模型（见表 2-1）。

表 2-1 威胁与所需属性
| **威胁** | **所需属性** |
| :--- | :--- |
| 欺骗 | 身份验证 |
| 篡改 | 完整性 |
| 否认 | 不可否认 |
| 信息暴露 | 机密性 |
| 拒绝服务 | 可适用 |
| 权限提升 | 鉴权 |

在系统固件中，拒绝服务在当前的启动过程中可能是暂时的，也有可能是永久的，在这种情况下，系统不能再次正常启动。后者更为严重，被命名为永久性拒绝服务（PDoS）。

针对固件STRIDE模型，将考虑如表 2-2中所示的对手。

表 2-2 对手与示例
| **对手** | **示例** |
| :--- | :--- |
| 网络攻击者 | 攻击者可能通过网络连接系统以进行窃听，拦截、伪装或修改网络数据包 |
| 无特权软件攻击者 | 攻击者可能在操作系统的应用层中运行ring 3级别的软件。攻击者可能执行基于软件的侧信道攻击（例如使用高速缓存计时）。|
| 系统软件攻击者 | 攻击者可能在操作系统的内核或管理程序中运行ring 0级别的软件。或攻击者可能在固件启动阶段运行第三方固件代码。攻击者可能执行基于软件的侧信道攻击（例如使用高速缓存计时，性能计数，分支信息或电源状态）。|
| 简单的硬件攻击者 | 攻击者可能接触平台硬件（如电源按钮或跳线），并连接/移除简单的恶意设备（例如硬件调试器，PCI吸附外部接口，PCIe[外围组件互联接口]卡接入PCIe卡槽，内存DIMM，NIC电缆，硬驱，键盘，USB设备，蓝牙设备）。攻击者可能劫持简单的设备总线（例如串行外围接口[SPI]总线或I2C总线）。 |
| 有技巧的硬件攻击 | 攻击者可能劫持复杂的系统总线，例如内存总线和PCIe总线。攻击者可能执行基于硬件的侧信道攻击，例如功率分析，热分析和电磁分析。攻击者可能执行故障攻击。 |

根据美国国家标准与技术研究所（NIST）SP800-193的规定，系统固件设计需要考虑保护、检测和恢复。

为了与BIOS的要求相匹配，BIOS的主要安全目标包括以下内容：
1. 阻止对BIOS代码和关键数据进行任何未经授权的修改（保护）。
2. 使固件组件成为信任链（CoT）的一部分，并提供平台认证（检测）。
3. 在损坏或非法修改后将BIOS恢复到真实状态
修改（恢复）。

三大支柱——保护、检测和恢复——也被认为是主要的缓解措施。对BIOS而言需要考虑的资产是闪存内容、启动流程、S3恢复、管理模式和构建工具。需要对每项资产进行分析。

### 闪存内容
NIST SP800-147和SP800-147B提供了系统固件保护指南，包括系统固件保护和更新的详细信息。NIST SP800-193提供了平台固件弹性指南。它将保护扩展到三个原则：保护、检测和恢复。它还将范围从系统固件（BIOS）扩大到平台上的所有固件。

此处的闪存内容包括固件代码（例如，预先可扩展固件接口初始化（PEI）、驱动程序执行环境（DXE）和引导设备选择（BDS）等）和固件数据（例如，UEFI变量、微代码等）。有关闪存内容的威胁、对手和缓解，请参阅表2-3、2-4和2-5。

表 2-3 针对资产的威胁 —— 闪存内容
| **威胁** | **示例** |
| :--- | :--- |
| 欺骗 | 无 |
| 篡改 | 如果固件没有受到保护或锁定，攻击者可能会直接修改固件。如果固件更新过程未通过验证，则攻击者可能会发送恶意的固件更新映像进行更新。|
| 否认 | 如果固件没有正确实现事件日志记录，恶意程序可能会擦除或截断日志。|
| 信息泄露 | 如果系统软件将机密存储在固件中，则攻击者可能读取固件内容并获取机密。|
| 拒绝服务 | 如果攻击者可以修改固件内容（代码或数据）并导致固件崩溃，则系统可能不再启动。这变成了永久性的拒绝服务。|
| 权限提升 | 如果攻击者可以修改固件内容（代码或数据）并将木马程序存储在固件中，则木马程序可能会隐藏自己并获得更高的权限。|


