## 第七章

# 可信启动

对于开发人员来说，中情局的保密性、完整性和可用性三要素始终是最重要的。关于 "完整性"，安全启动是帮助维护平台完整性要求的珍贵功能。它也被称为验证启动。启用安全启动后，组件将在执行下一个组件之前对其进行验证。如果验证失败，下一个组件将不会被执行。这看起来非常有用。但其他软件如何知道安全启动是否已启用且启用正确？其他软件如何知道是否安全启动被错误禁用？

如今，即使我们相信系统是安全的，我们仍希望让其他实体有机会确认这种安全属性。一旦系统有办法证明它拥有这些属性，我们就可以说它是可信的。

| **注释** | “信任” 的定义不同于 “安全”。根据可信计算小组（TCG）的定义，如果一个实体总是以预期的方式达到预期的目的，那么它就是可信的。可信的系统可能不是安全的系统。例如，如果我们知道一个系统被病毒感染，而病毒每天下午5点扫描C盘，并通过http协议将所有doc文件上传到特定的 URL，那么我们就可以说这个系统是可信的，而不是安全的。|
| :--- | :--- |

TCG定义了一种让其他软件检查系统是否已启动到可信环境的方法。该过程称为TCG可信启动。

## 静态的测量信任根（SRTM）

TCG规范定义了特殊硬件 —— 可信平台模块（TPM）。TPM有一组加密引擎、非易失性存储、易失性存储和一组平台配置寄存器（PCR）。TCG规范定义了一组信任根（RoT）：

    • 测量信任根（RTM）：RTM执行初始测量过程。RTM是主机端的一些代码。在实际实现中，我们有两种不同类型的RTM —— 静态RTM（SRTM）或动态 RTM（DRTM）。我们将在后面讨论它们。RTM可能包括许多组件。在这些组件中，核心RTM（CRTM）指的是在平台重置后运行最初代码的组件。
    • 报告信任根（RTR）：RTR通过TPM PCR报告测量信息，并提供基于TPM身份验证PCR真实性的能力。
    • 存储信任根（RTS）：RTS为密钥和数据提供受保护的存储区域。

### 可信平台模块

TPM包括除了测量信任根之外的所有受信任功能。本书重点介绍如何在固件中使用TPM。有关TPM硬件及其功能的详细介绍，请参阅TPM规范或参考文献中列出的书籍。

TPM的平台配置寄存器(PCR)保存最终测量值。测量值遵循此处给出的等式。此操作为PCR扩展：

PCR<sub>(new)</sub> = HASH(PCR<sub>(old)</sub> || HASH(Data))

PCR扩展是修改PCR值的唯一方法。如果平台多次扩展PCR，所有数据都会散列到PCR中。

当平台使用SRTM时，C-SRTM是固件启动块代码。启动块固件可以是UEFI/PI BIOS中的PEI固件卷。它也可以是coreboot BIOS中的ROM阶段。如果启用了英特尔Boot Guard功能，它也可以是英特尔Boot Guard ACM。见图7-1。根据TCG平台固件概述规范，RTM需要测量所有的其他组件。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-1.jpg></img></div>
<div align=center>图 7-1 使用SRTM的固件测量</div>

根据TCG平台固件概述规范，该C-SRTM必须测量自身，并将测量值写入到PCR0中，其余组件（代码或数据）必须通过信任链测量，然后写入测量值到相应的PCR中。见表7-1。

表 7-1 SRTM PCR测量值
| PCR索引 | 用法 |
| :--- | :--- |
| 0 | SRTM，BIOS，主机平台扩展，嵌入式option ROM和PI驱动 |
| 1 | 主机平台配置 |
| 2 | UEFI驱动和应用代码 |
| 3 | UEFI驱动和应用配置和数据 |
| 4 | UEFI启动管理代码（或在主启动记录（MBR）中初始程序加载器（IPL））和启动尝试 |
| 5 | UEFI启动管理配置和数据（被启动管理代码使用）和GUID分区表（GPT）（或传统MBR分区表）|
| 6 | 主机平台特定制造商 |
| 7 | 安全启动策略 |

可信启动与安全启动不同。在安全启动中，一个组件需要认证下一个组件。安全启动需要在加载下一个组件前检查签名或哈希值。如果签名无效或哈希值不匹配，安全启动将停止平台启动。在可信启动中，一个组件在加载下一个组件之前，需要将测量下一个组件，把测量值写入到TPM PCR中。测量启动不会失败，因为在启动过程中不会执行验证。一旦系统完成启动后，其他软件将通过使用验证来检查当前状态是否与先前状态相同，从而做出安全决定。有关区别见图7-2和7-3。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-2.jpg></img></div>
<div align=center>图 7-2 安全启动和可信启动流程</div>

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-3.jpg></img></div>
<div align=center>图 7-3 安全启动对比可信启动</div>

### TPM设备类型

第一个TPM产品遵循TPM规范1.2版本，也称作TPM1.2。然而，随着时间的推移，发现，TPM1.2规范存在一些局限性。例如，TPM1.2只支持SHA1哈希算法和RSA非对称算法。一旦操作系统获得TPM1.2的所有权，平台BIOS就可能无法使用TPM。

为了解决这些限制，TCG定义了TPM规范系列2.0，又称TPM2.0。TPM2.0支持灵活的加密技术。TPM2.0设备可支持SHA1、SHA256、SM3_256或未来的算法，例如SHA3_256或SHA3_384。TPM2.0为平台固件使用定义了专用的平台层次结构。操作系统管理的存储层次结构独立于平台层次结构。TPM2.0为使用授权功能提供了统一的框架，并扩展了授权方法 —— 清晰的明文密码和基于哈希的消息验证码（HMAC）。

除了TPM1.2和TPM2.0，中国政府定义了可信密码模块（Trusted Cryptography Module，TCM）。TCM提供了报告信任根（RTR）和存储信任根（RTS），并支持可信启动。从功能角度看，它与TPM相似。例如，TCM定义了平台配置寄存器（PCR）、非易失性存储、担保密钥、身份密钥等。TCM仅支持中国加密学算法 —— SM2、SM3和SMS4。

与TPM类似，可信加密模块也是被动设备。为了支持主动测量，中国政府标准定义了可信平台控制模块（TPCM）。除了RTR和RTS外，TPCM 提供了测量信任根（RTM）。系统上电后，TPCM测量平台BIOS，并将结果记录到PCR中，然后TPCM将控制权转移给主机CPU。

### 测量值汇报

PCR保存测量组件（代码和/或数据）的最终哈希值。它可用于显示当前平台状态。然而，从PCR最终值中获取个别测量值是不可行的。但在某些情况下，可能需要单个测量值。因此，TCG定义了完整性测量事件日志来记录个别测量哈希值和测量描述。见图7-4。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-4.jpg></img></div>
<div align=center>图 7-4 TCG测量事件与PCR</div>

在系统启动期间，每当固件将测量值记录到PCR中时，相应的事件就会被添加到事件日志中。最后，事件日志将传递给操作系统（见图7-5）。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-5.jpg></img></div>
<div align=center>图 7-5 启动期间TCG测量事件日志记录</div>

由于事件日志在易失性存储中，而该内存不是报告的信任根或存储的信任根，因此事件日志不可信，必须小心谨慎。只有来自TPM芯片的PCR才是可信的。在使用事件日志时，验证者必须提取每个TCG事件，并从事件日志中重建PCR值，然后与TPM芯片中的PCR值进行比较。如果不匹配，则TCG事件日志不可信。如果两者匹配，来自TCG事件日志的摘要值才可信。

### 证明

证明是指在机器（证明人）上存在的供另一个实体（鉴定人或验证人）验证的证据。若有TPM，证据就是PCR的值。如果验证者要检查系统是否处于已知的良好状态，就必须信任PCR值的真实性。这可能发生在本地平台或远程的验证者中。如果PCR值是通过不可信的环境传输的，例如软件栈或网络，那么我们就需要TPM_Quote操作来提供保护。TPM_Quote是个命令，它使用TPM私钥给一组PCR值签名，并提供数字签名。然后，验证者可以执行数字签名验证，并信任收集到的PCR值。此时，验证器可将收集到的PCR值与一组参考PCR测量值比较，以确定这是否是预期的平台。

直接比较PCR值是一种简单的方法。但是，TPM只提供了八个PCR值供平台使用。可能有这样一种情况，平台希望在一个PCR中断言某些测量值，而跳过其他一些测量值。因此，可以使用TCG事件日志。

在基于TCG事件日志的验证中，第一步也是验证PCR值的真实性。然后，验证者需要从事件日志中重建PCR值，来验证事件日志中测量值的真实性。最后，验证者可以将收集到的完整性测量事件日志与极好的参考测量值列表进行比较。现在，可以根据验证策略支持部分比较。

图7-6显示了在NIST SP800-155中定义的验证示例。测量评估权威机构（MAA）—— 鉴定人 —— 从端设备（即证明者）处收集事件日志和 PCR。MAA还会从一组受支持的供应机构，例如原始设备制造商 (OEM) 和增值经销商 (VAR)，获取极好的测量值。然后，MAA 将事件日志与极好的测量值进行比较，看它们是否匹配。如果不匹配，MAA可以会让端设备开始修复。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-6.jpg></img></div>
<div align=center>图 7-6 使用良好的参考测量值进行测量值评估</div>

报文交换细节如图7-7所示。首先，MAA从端设备获取引用（Quote）。引用是用TPM证明密钥（AK）签名的TPM PCR值列表。引用是当前平台状态的证明。一旦MAA获取引用，MAA就会使用公开的验证密钥来验证引用值，这就是所谓的远程证明。然后，MAA从客户端收集完整的事件日志，并回放事件日志来生成PCR列表。如果生成的PCR与引用PCR匹配，则表示事件日志未被篡改。该事件日志可用于与极好的测量值比较。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-7.jpg></img></div>
<div align=center>图 7-7 TCG远程证明流程</div>

完整的远程证明还包括通过使用TPM担保密钥（EK）来验证TPM的过程。每个TPM都包含一个唯一的EK对，位于TPM上的保护位置。EK的公钥包含在EK证书中。一个EK证书用于协助验证CA签发仅用于签名目的的验证密钥 (AK)。EK证书可用提供证明AK与EK位于同一TPM上。

### S3恢复

为了提高能效，平台可能支持休眠，根据高级配置和电源接口（ACPI）规范中的定义，休眠也称为S3恢复。如果系统需要进入S3状态，操作系统会保存当前系统配置，设置操作系统唤醒向量，并写芯片专用寄存器。然后平台硬件进入S3状态。CPU和大多数设备处于关闭状态。系统内存处于自刷新状态，以保持内存内容的可用性。最终用户唤醒系统后，SRTM-BIOS开始运行。BIOS根据保存的配置初始化系统，并跳转到操作系统唤醒向量。

在正常的系统关机和系统启动过程中，操作系统向TPM发送TPM_Shutdown(CLEAR)命令，BIOS向TPM发送TPM_Startup(CLEAR)命令，它将TPM上下文重置为默认初始化状态。S3恢复则不同。为了维护信任链，操作系统需要在系统进入S3之前发送TPM_Shutdown(STATE)命令，然后TPM会保存当前上下文，包括所有PCR值。当BIOS启动时，BIOS会发送TPM_Startup(STATE)命令，将TPM恢复到进入S3之前的原始状态，包括所有PCR值。在正常的S3恢复中，不需要为SRTM执行PCR扩展。

然而，如果TPM_Startup(STATE)由于某种原因失败，SRTM需要尝试TPM_Startup(CLEAR)来重新启动TPM。如果TPM重启成功，SRTM需要向PCR扩展错误代码，因为SRTM在S3中以不同的启动路径运行，不可能重放正常启动流程以创建相同的PCR。

### 设备标识符合成引擎（DICE）

TPM广泛应用于个人计算、移动、和服务器平台。然而，物联网（IoT）市场可能会有不同的解决方案，应对功耗、安全性、资源和其他方面的挑战。并非所有物联网系统和组件都采用TPM。因此，TCG创建了设备标识符合成引擎（DICE）工作组，以开发新的方法来提高安全性和隐私性，同时将芯片要求降至最低。即使是最微小的微控制器也能支持DICE，以建立设备标识并执行证明和安全固件更新。

图7-8显示了DICE的基本思想。不可改变ROM —— DICE硬件引擎将唯一设备机密（UDS）和启动代码的哈希结合起来，创建一个基于哈希的消息认证码（HMAC）。该HMAC用作设备的复合设备标识（CDI）。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-8.jpg></img></div>
<div align=center>图 7-8 DICE SOC</div>

等式是：

    CDI = HMAC(UDS, Hash(Code))

如果更新了固件启动代码，就会自动生成新的CDI。这可能是一项功能。但是，如果旧CDI被用于设备标识，则补丁过的设备上的新CDI将无法识别。这可能会带来一些可管理性问题。更好的解决方案是将代码分层。见图7-9。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-9.jpg></img></div>
<div align=center>图 7-9 分层的DICE架构</div>

CDI由带有UDS的SOC硬件和启动代码的哈希值生成。然后，DICE核心（第0层）使用CDI派生设备ID密钥对。设备ID密钥对是设备的标识符，不应在DICE核心之外泄露。为了在不暴露设备ID密钥的情况下证明对设备ID私有部分的了解，DICE核心需要为下一层生成一个新的密钥对。这个密钥对被称为别名密钥。别名密钥对派生自CDI和下一层（设备固件）的标识。该密钥可传递给设备固件层，并且密钥的私有部分可在设备固件生命周期内使用。设备固件需要确保别名密钥不会泄露到设备固件之外。设备固件更新会导致别名密钥对更新，但不会影响设备ID密钥对。DICE核心也会为使用设备ID私钥签名的别名密钥创建证书和自签名设备ID证书。设备ID证书在设备生命周期内不会更改，而别名密钥证书则会在固件更新时频繁更改。

DICE核心实现可以容易的扩展到多层启动。每一层都会为下一层创建新的别名密钥和别名证书。签发给下一层的别名证书由当前层授予的别名密钥签名。

DICE和TPM使用不同的密钥保护机制。在TPM解决方案中，密钥存储和使用在一个由硬件和软件组合而成的隔离环境中，并且密钥可随时使用。这被称为*空间上*的保护。DICE设计依赖于密钥的*时间上*的保护。密钥来自于启动链中的前一个组件，仅在当前组件中使用，然后在将控制权转移到下一个组件之前从内存中删除。使用密钥的加密操作只能在有限的时间内执行。图7-10和7-11显示了两者的区别。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-10.jpg></img></div>
<div align=center>图 7-10 TPM密钥保护</div>

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-11.jpg></img></div>
<div align=center>图 7-11 DICE密钥保护</div>

DICE规范仍在开发中。更多的细节请参考最新的DICE文档。

### 案例研究

现在。让我们看一下SRTM实现的一些实例。

#### UEFI BIOS中的测量启动支持

当前的UEFI BIOS实现，例如基于EDK II的实现，支持TCG可信启动。UEFI BIOS测量所需的组件，例如PEI模块、DXE模块、SMM模块、UEFI驱动程序和数据（如配置变量）等，到相应的PCR。图7-12和表7-2显示了平台中的组件及其相应的PCR值。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-12.jpg></img></div>
<div align=center>图 7-12 UEFI BIOS中的PCR</div>

表 7-2 UEFI BIOS中的PCR测量
| PCR索引 | TCG定义的用法 | UEFI例子 |
| :--- | :--- | :--- |
| 0 | CRTM，主机平台代码 | CRTM，平台固件（PEI、DXE、SMM、UEFI启动服务、UEFI运行时服务、嵌入式去驱动），非主机固件存在（类型、版本）
| 1 | 主机固件配置 | CMOS配置，UEFI启动变量，UEFI配置变量， ACPI表，SMBIOS表，Microcode，底座 |
| 2 | UEFI驱动代码 | Option ROM，设备固件，非主机固件 |
| 3 | UEFI驱动配置和数据 | Option ROM配置，设备固件配置，非主机固件配置 |
| 4 | UEFI启动管理代码 | 操作系统启动程序 |
| 5 | UEFI启动管理代码配置和数据 | UEFI启动操作，GPT分区 |
| 6 | 主机平台特定制造商 | 无 |
| 7 | 安全启动策略 | UEFI安全启动策略（PK、KEK、db、dbx、dbt、dbr、安全启动状态、审计模式、部署模式），安全状态，调试状态 |


