## 第七章

# 可信启动

对于开发人员来说，中情局的保密性、完整性和可用性三要素始终是最重要的。关于 "完整性"，安全启动是帮助维护平台完整性要求的珍贵功能。它也被称为验证启动。启用安全启动后，组件将在执行下一个组件之前对其进行验证。如果验证失败，下一个组件将不会被执行。这看起来非常有用。但其他软件如何知道安全启动是否已启用且启用正确？其他软件如何知道是否安全启动被错误禁用？

如今，即使我们相信系统是安全的，我们仍希望让其他实体有机会确认这种安全属性。一旦系统有办法证明它拥有这些属性，我们就可以说它是可信的。

| **注释** | “信任” 的定义不同于 “安全”。根据可信计算小组（TCG）的定义，如果一个实体总是以预期的方式达到预期的目的，那么它就是可信的。可信的系统可能不是安全的系统。例如，如果我们知道一个系统被病毒感染，而病毒每天下午5点扫描C盘，并通过http协议将所有doc文件上传到特定的 URL，那么我们就可以说这个系统是可信的，而不是安全的。|
| :--- | :--- |

TCG定义了一种让其他软件检查系统是否已启动到可信环境的方法。该过程称为TCG可信启动。

## 静态的测量信任根（SRTM）

TCG规范定义了特殊硬件 —— 可信平台模块（TPM）。TPM有一组加密引擎、非易失性存储、易失性存储和一组平台配置寄存器（PCR）。TCG规范定义了一组信任根（RoT）：

    • 测量信任根（RTM）：RTM执行初始测量过程。RTM是主机端的一些代码。在实际实现中，我们有两种不同类型的RTM —— 静态RTM（SRTM）或动态 RTM（DRTM）。我们将在后面讨论它们。RTM可能包括许多组件。在这些组件中，核心RTM（CRTM）指的是在平台重置后运行最初代码的组件。
    • 报告信任根（RTR）：RTR通过TPM PCR报告测量信息，并提供基于TPM身份验证PCR真实性的能力。
    • 存储信任根（RTS）：RTS为密钥和数据提供受保护的存储区域。

### 可信平台模块

TPM包括除了测量信任根之外的所有受信任功能。本书重点介绍如何在固件中使用TPM。有关TPM硬件及其功能的详细介绍，请参阅TPM规范或参考文献中列出的书籍。

TPM的平台配置寄存器(PCR)保存最终测量值。测量值遵循此处给出的等式。此操作为PCR扩展：

PCR<sub>(new)</sub> = HASH(PCR<sub>(old)</sub> || HASH(Data))

PCR扩展是修改PCR值的唯一方法。如果平台多次扩展PCR，所有数据都会散列到PCR中。

当平台使用SRTM时，C-SRTM是固件启动块代码。启动块固件可以是UEFI/PI BIOS中的PEI固件卷。它也可以是coreboot BIOS中的ROM阶段。如果启用了英特尔Boot Guard功能，它也可以是英特尔Boot Guard ACM。见图7-1。根据TCG平台固件概述规范，RTM需要测量所有的其他组件。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-1.jpg></img></div>
<div align=center>图 7-1 使用SRTM的固件测量</div>

根据TCG平台固件概述规范，该C-SRTM必须测量自身，并将测量值写入到PCR0中，其余组件（代码或数据）必须通过信任链测量，然后写入测量值到相应的PCR中。见表7-1。

表 7-1 SRTM PCR测量值
| PCR索引 | 用法 |
| :--- | :--- |
| 0 | SRTM，BIOS，主机平台扩展，嵌入式option ROM和PI驱动 |
| 1 | 主机平台配置 |
| 2 | UEFI驱动和应用代码 |
| 3 | UEFI驱动和应用配置和数据 |
| 4 | UEFI启动管理代码（或在主启动记录（MBR）中初始程序加载器（IPL））和启动尝试 |
| 5 | UEFI启动管理配置和数据（被启动管理代码使用）和GUID分区表（GPT）（或传统MBR分区表）|
| 6 | 主机平台特定制造商 |
| 7 | 安全启动策略 |

可信启动与安全启动不同。在安全启动中，一个组件需要认证下一个组件。安全启动需要在加载下一个组件前检查签名或哈希值。如果签名无效或哈希值不匹配，安全启动将停止平台启动。在可信启动中，一个组件在加载下一个组件之前，需要将测量下一个组件，把测量值写入到TPM PCR中。测量启动不会失败，因为在启动过程中不会执行验证。一旦系统完成启动后，其他软件将通过使用验证来检查当前状态是否与先前状态相同，从而做出安全决定。有关区别见图7-2和7-3。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-2.jpg></img></div>
<div align=center>图 7-2 安全启动和可信启动流程</div>

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-3.jpg></img></div>
<div align=center>图 7-3 安全启动对比可信启动</div>

### TPM设备类型

第一个TPM产品遵循TPM规范1.2版本，也称作TPM1.2。然而，随着时间的推移，发现，TPM1.2规范存在一些局限性。例如，TPM1.2只支持SHA1哈希算法和RSA非对称算法。一旦操作系统获得TPM1.2的所有权，平台BIOS就可能无法使用TPM。

为了解决这些限制，TCG定义了TPM规范系列2.0，又称TPM2.0。TPM2.0支持灵活的加密技术。TPM2.0设备可支持SHA1、SHA256、SM3_256或未来的算法，例如SHA3_256或SHA3_384。TPM2.0为平台固件使用定义了专用的平台层次结构。操作系统管理的存储层次结构独立于平台层次结构。TPM2.0为使用授权功能提供了统一的框架，并扩展了授权方法 —— 清晰的明文密码和基于哈希的消息验证码（HMAC）。

除了TPM1.2和TPM2.0，中国政府定义了可信密码模块（Trusted Cryptography Module，TCM）。TCM提供了报告信任根（RTR）和存储信任根（RTS），并支持可信启动。从功能角度看，它与TPM相似。例如，TCM定义了平台配置寄存器（PCR）、非易失性存储、担保密钥、身份密钥等。TCM仅支持中国加密学算法 —— SM2、SM3和SMS4。

与TPM类似，可信加密模块也是被动设备。为了支持主动测量，中国政府标准定义了可信平台控制模块（TPCM）。除了RTR和RTS外，TPCM 提供了测量信任根（RTM）。系统上电后，TPCM测量平台BIOS，并将结果记录到PCR中，然后TPCM将控制权转移给主机CPU。

### 测量值汇报

PCR保存测量组件（代码和/或数据）的最终哈希值。它可用于显示当前平台状态。然而，从PCR最终值中获取个别测量值是不可行的。但在某些情况下，可能需要单个测量值。因此，TCG定义了完整性测量事件日志来记录个别测量哈希值和测量描述。见图7-4。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-4.jpg></img></div>
<div align=center>图 7-4 TCG测量事件与PCR</div>

在系统启动期间，每当固件将测量值记录到PCR中时，相应的事件就会被添加到事件日志中。最后，事件日志将传递给操作系统（见图7-5）。

<div align=center><img src=Figures/Chapter-7-Screenshot/Figure-7-5.jpg></img></div>
<div align=center>图 7-5 启动期间TCG测量事件日志记录</div>

由于事件日志在易失性存储中，而该内存不是报告的信任根或存储的信任根，因此事件日志不可信，必须小心谨慎。只有来自TPM芯片的PCR才是可信的。在使用事件日志时，验证者必须提取每个TCG事件，并从事件日志中重建PCR值，然后与TPM芯片中的PCR值进行比较。如果不匹配，则TCG事件日志不可信。如果两者匹配，来自TCG事件日志的摘要值才可信。

### 证明

证明是指在机器（证明人）上存在的供另一个实体（鉴定人或验证人）验证的证据。若有TPM，证据就是PCR的值。如果验证者要检查系统是否处于已知的良好状态，就必须信任PCR值的真实性。这可能发生在本地平台或远程的验证者中。如果PCR值是通过不可信的环境传输的，例如软件栈或网络，那么我们就需要TPM_Quote操作来提供保护。TPM_Quote是个命令，它使用TPM私钥给一组PCR值签名，并提供数字签名。然后，验证者可以执行数字签名验证，并信任收集到的PCR值。此时，验证器可将收集到的PCR值与一组参考PCR测量值比较，以确定这是否是预期的平台。

直接比较PCR值是一种简单的方法。但是，TPM只提供了八个PCR值供平台使用。可能有这样一种情况，平台希望在一个PCR中断言某些测量值，而跳过其他一些测量值。因此，可以使用TCG事件日志。

